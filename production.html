<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>InventoryHub - Production System</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Papa Parse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Leaflet (Map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Form validation styles */
    input.error, select.error, textarea.error {
      border-color: var(--danger) !important;
      background-color: #fee2e2 !important;
    }

    input.success, select.success, textarea.success {
      border-color: var(--ok) !important;
    }

    .field-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    /* ====== Design Tokens ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#667eea; --primary-700:#5568d3; --accent:#764ba2;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --bg:#f6f7fb; --card:#fff; --soft:#f1f5f9; --text:#111827; --muted:#6b7280;
      --radius:12px;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    :focus-visible{outline:2px solid var(--primary);outline-offset:2px;border-radius:8px}
    .hidden{display:none!important}

    /* ====== Login ====== */
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--primary),var(--accent));padding:24px}
    .login-box{width:100%;max-width:420px;background:var(--card);padding:38px;border-radius:var(--radius);
      box-shadow:0 18px 40px rgba(0,0,0,.2)}
    .login-box h1{font-size:28px;margin-bottom:8px}
    .login-box p{color:var(--muted);margin-bottom:18px}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:#374151}
    .form-group input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px}
    .form-group input:focus{border-color:var(--primary)}
    .login-btn{width:100%;padding:13px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:800;cursor:pointer}
    .login-btn:hover{background:var(--primary-700)}
    .demo-note{margin-top:12px;padding:10px;background:#fff7d6;border-radius:8px;color:#8a5a00;font-size:13px}

    /* ====== App Shell ====== */
    .app{max-width:1200px;margin:0 auto;padding:18px}
    .brandbar{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;border-radius:14px;
      padding:18px 20px;margin:18px 0;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brandbar h1{font-size:22px;margin-bottom:4px}
    .brandbar small{opacity:.9}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-700)}
    .btn-secondary{background:#eef2ff}.btn-secondary:hover{background:#e0e7ff}
    .btn-success{background:var(--ok);color:#fff}
    .btn-warning{background:var(--warn);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-sm{padding:6px 10px;font-size:12px}
    .logout-btn{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.5)}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{background:#fff;border:1.5px solid #e5e7eb;color:#111827;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
    .tab[aria-selected="true"]{border-color:#c7d2fe;background:#eef2ff}
    .tabpanes{background:var(--card);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .pane{padding:16px}

    /* Toast */
    .toast{position:fixed;top:18px;right:18px;background:var(--ok);color:#fff;padding:12px 16px;border-radius:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);opacity:0;transform:translateY(-8px);transition:all .25s;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)} .toast.error{background:var(--danger)}

    /* KPIs */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:8px 0 2px}
    .stat{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:16px;position:relative}
    .stat .dot{position:absolute;right:12px;top:12px;width:8px;height:8px;border-radius:999px;background:var(--primary)}
    .stat .label{font-size:12px;text-transform:uppercase;color:#6b7280;font-weight:800;letter-spacing:.04em}
    .stat .value{font-size:26px;font-weight:800;color:#111827;margin-top:6px}

    /* Filters & Actions */
    .filterbox{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:16px;margin:12px 0}
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:10px}
    .filter-grid label{font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:800;margin-bottom:4px;display:block}
    .filter-grid input,.filter-grid select{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px}
    .toggles{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}

    /* Dropzone */
    .dropzone{border:2px dashed #c7d2fe;background:#eef2ff;border-radius:12px;padding:14px;text-align:center;color:#1e3a8a}
    .dropzone.drag{background:#e0e7ff;border-color:var(--primary)}

    /* Table */
    .tablewrap{background:#fff;border:1px solid #eef2ff;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead{background:var(--primary);color:#fff}
    th{padding:14px;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
    td{padding:12px 14px;border-bottom:1px solid #f1f5f9}
    tbody tr:hover{background:#f8f9ff}
    .price{font-weight:800;color:#10b981}
    .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800}
    .badge-active{background:#d1fae5;color:#065f46}
    .badge-inactive{background:#fee2e2;color:#991b1b}
    .badge-available{background:#dbeafe;color:#1e40af}

    /* Pagination */
    .pagination{display:flex;justify-content:space-between;align-items:center;padding:14px;background:#fafafa}
    .rows-select{padding:8px 10px;border:2px solid #e5e7eb;border-radius:8px}

    /* Grid Cards + Carousel */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .carousel{position:relative;height:140px;background:#e5e7eb}
    .carousel img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}
    .carousel img.active{display:block}
    .carousel .dots{position:absolute;bottom:8px;left:0;right:0;display:flex;gap:6px;justify-content:center}
    .carousel .dot{width:7px;height:7px;border-radius:999px;background:rgba(255,255,255,.8)}
    .carousel .dot.active{background:#fff}
    .card-body{padding:12px 14px}
    .card-title{font-weight:800;margin-bottom:4px}
    .card-meta{font-size:13px;color:#4b5563}
    .card-badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .card-actions{display:flex;gap:6px;margin-top:10px}

    /* Loading skeleton */
    .loading{padding:28px;text-align:center;color:#6b7280}
    .skeleton-row{display:grid;grid-template-columns:2fr 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;gap:12px;padding:12px 14px}
    .sk{height:14px;border-radius:6px;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:sk 1.1s linear infinite}
    @keyframes sk{0%{background-position:0 0}100%{background-position:-200% 0}}

    /* ====== Map ====== */
    #map{height:500px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    .leaflet-popup-content-wrapper{border-radius:10px;padding:0}
    .leaflet-popup-content{margin:0;width:280px!important}
    .map-popup{padding:12px}
    .map-popup h3{font-size:16px;margin-bottom:8px;color:#111827}
    .map-popup .detail{display:flex;justify-content:space-between;margin:4px 0;font-size:13px}
    .map-popup .detail .label{color:#6b7280;font-weight:600}
    .map-legend{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-top:10px}
    .map-legend h4{font-size:13px;font-weight:800;margin-bottom:8px;text-transform:uppercase;color:#374151}
    .map-legend-item{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:13px}
    .map-legend-item .dot{width:12px;height:12px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.1)}

    /* ====== Calendar / Bookings ====== */
    .booking-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-bottom:10px}
    .booking-card h4{margin-bottom:6px;font-size:15px}
    .booking-card .meta{font-size:13px;color:#6b7280;margin:4px 0}
    .booking-status{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:800;text-transform:uppercase}
    .booking-status.pending{background:#fef3c7;color:#92400e}
    .booking-status.confirmed{background:#d1fae5;color:#065f46}
    .booking-status.completed{background:#e0e7ff;color:#3730a3}
    .booking-status.cancelled{background:#fee2e2;color:#991b1b}

    /* Bulk Actions */
    .bulk-bar{background:#fff;border:1px solid #e7eaf3;border-radius:10px;padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .bulk-bar.hidden{display:none}
    .checkbox-cell{width:40px;text-align:center}
    .checkbox-cell input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .preset-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .preset-filter{padding:8px 12px;background:#fff;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s}
    .preset-filter:hover{border-color:#c7d2fe;background:#f8f9ff}
    .preset-filter.active{border-color:var(--primary);background:#eef2ff;color:var(--primary)}
    .search-highlight{background:#fef08a;padding:2px 4px;border-radius:3px}

    /* spinner keyframes */
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Calendar */
    .calendar-day{
      min-height:90px;
      padding:6px;
      border:1px solid #e5e7eb;
      background:#fff;
      position:relative;
      cursor:pointer;
      transition:background .2s;
    }
    .calendar-day:hover{background:#f8f9ff}
    .calendar-day.other-month{background:#f9fafb;color:#9ca3af}
    .calendar-day.today{background:#eef2ff;border:2px solid var(--primary)}
    .calendar-day-number{
      font-weight:700;
      font-size:13px;
      margin-bottom:4px;
      color:#111827;
    }
    .calendar-day.other-month .calendar-day-number{color:#9ca3af}
    .calendar-booking{
      font-size:10px;
      padding:2px 4px;
      border-radius:3px;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:600;
      color:#fff;
    }
    .calendar-booking.confirmed{background:#10b981}
    .calendar-booking.pending{background:#f59e0b}
    .calendar-booking.completed{background:#667eea}
    .calendar-booking.cancelled{background:#ef4444}
    .calendar-booking-count{
      position:absolute;
      bottom:4px;
      right:4px;
      background:#667eea;
      color:#fff;
      font-size:10px;
      font-weight:700;
      padding:2px 6px;
      border-radius:10px;
    }
  </style>
</head>
<body>
  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loadingOverlay" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:1000">
    <div style="background:#fff;padding:24px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
      <div style="width:40px;height:40px;border:4px solid #e5e7eb;border-top-color:#667eea;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto"></div>
      <div style="margin-top:12px;color:#6b7280;font-weight:600">Processing...</div>
    </div>
  </div>

  <!-- ====== Login ====== -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <h1>InventoryHub</h1>
      <p>Sign in to manage your billboards.</p>
      <form onsubmit="handleLogin(event)" novalidate>
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" placeholder="you@example.com" required />
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" placeholder="********" required />
        </div>
        <button class="login-btn" type="submit">Sign In</button>
      </form>
      <div class="demo-note"><strong>Note:</strong> This screen uses real Supabase authentication.</div>
    </div>
  </div>

  <!-- ====== App ====== -->
  <div id="app" class="app hidden">
    <div class="brandbar">
      <div>
        <h1>InventoryHub</h1>
        <small id="userInfo">Signed in</small>
      </div>
      <div class="top-actions" role="toolbar" aria-label="Quick actions">
        <button class="btn btn-secondary" onclick="syncNow()">Sync</button>
        <button class="btn btn-secondary" onclick="exportCurrentView()">Export CSV</button>
        <button class="btn btn-success" onclick="document.getElementById('csvFile').click()">Bulk Upload</button>
        <button class="btn btn-warning" onclick="openAddModal()">Add Billboard</button>
        <button class="btn logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Primary navigation">
      <button id="tab-dashboard" class="tab" role="tab" aria-selected="true" onclick="setTab('dashboard')">Dashboard</button>
      <button id="tab-inventory" class="tab" role="tab" aria-selected="false" onclick="setTab('inventory')">Inventory</button>
      <button id="tab-map" class="tab" role="tab" aria-selected="false" onclick="setTab('map')">Map View</button>
  <button id="tab-calendar" class="tab" role="tab" aria-selected="false" onclick="setTab('calendar')">Calendar</button>
  <button id="tab-apikeys" class="tab" role="tab" aria-selected="false" onclick="setTab('apikeys')">API Keys</button>
    </div>

    <!-- Panes -->
    <div class="tabpanes">
      <!-- Dashboard Pane -->
      <section id="pane-dashboard" class="pane" role="tabpanel" aria-labelledby="tab-dashboard">
  <!-- KPIs (Total Billboards, Active Sites, etc.) -->
  <div class="stats">
          <div class="stat">
            <span class="dot" aria-hidden="true"></span>
            <div class="label">Total Billboards</div>
            <div class="value" id="kpiTotal">-</div>
            <div id="kpiTotalTrend" style="font-size:12px;color:#10b981;margin-top:4px"></div>
          </div>
          <div class="stat">
            <span class="dot" aria-hidden="true"></span>
            <div class="label">Active Sites</div>
            <div class="value" id="kpiActive">-</div>
            <div id="kpiActivePct" style="font-size:12px;color:#6b7280;margin-top:4px"></div>
          </div>
          <div class="stat">
            <span class="dot" aria-hidden="true"></span>
            <div class="label">Current Bookings</div>
            <div class="value" id="kpiCurrentBookings">-</div>
            <div id="kpiBookingsPct" style="font-size:12px;color:#6b7280;margin-top:4px"></div>
          </div>
          <div class="stat">
            <span class="dot" aria-hidden="true"></span>
            <div class="label">Countries</div>
            <div class="value" id="kpiCountries">-</div>
            <div id="kpiStates" style="font-size:12px;color:#6b7280;margin-top:4px"></div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="filterbox" style="margin-top:20px">
          <h3 style="margin-bottom:12px;font-size:16px">Quick Actions</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
            <button class="btn btn-primary" onclick="setTab('inventory');setTimeout(()=>openAddModal(),100)" style="padding:14px">➕ Add New Billboard</button>
            <button class="btn btn-secondary" onclick="setTab('inventory')" style="padding:14px">📋 View All Inventory</button>
            <button class="btn btn-secondary" onclick="setTab('map')" style="padding:14px">🗺️ Open Map View</button>
            <button class="btn btn-success" onclick="document.getElementById('csvFile').click()" style="padding:14px">📤 Bulk Upload</button>
          </div>
        </div>

        <!-- Recent Bookings -->
        <div class="filterbox" style="margin-top:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:16px;margin:0">Recent Bookings</h3>
            <button class="btn btn-sm btn-secondary" onclick="loadDashboard()">Refresh</button>
          </div>
          <div id="dashboardRecentBookings">
            <div style="color:#6b7280;padding:20px;text-align:center">Loading...</div>
          </div>
        </div>

        <!-- ✅ Analytics (SINGLE INSTANCE) -->
        <div id="dashboardAnalytics" class="filterbox hidden" style="margin-top:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:16px">
            <h3 style="font-size:16px;margin:0;font-weight:700">📊 Revenue Analytics</h3>
            <select id="analyticsTimeRange" style="padding:8px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:600;align-self:center">
              <option value="6">Last 6 Months</option>
              <option value="3">Last 3 Months</option>
              <option value="12">Last 12 Months</option>
            </select>
          </div>
          <!-- KPIs Row -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
            <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;padding:16px;color:#fff">
              <div style="font-size:11px;text-transform:uppercase;font-weight:700;opacity:0.9;margin-bottom:6px">Revenue MTD</div>
              <div style="font-size:28px;font-weight:800" id="analyticsRevenueMTD">$0</div>
              <div style="font-size:11px;opacity:0.9;margin-top:4px" id="analyticsRevenueTrend">-</div>
            </div>
            <div style="background:#fff;border:2px solid #eef2ff;border-radius:12px;padding:16px">
              <div style="font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:700;margin-bottom:6px">Occupancy Rate</div>
              <div style="font-size:28px;font-weight:800;color:#111827" id="analyticsOccupancy">0%</div>
              <div style="font-size:11px;color:#6b7280;margin-top:4px" id="analyticsOccupancyDetail">-</div>
            </div>
            <div style="background:#fff;border:2px solid #eef2ff;border-radius:12px;padding:16px">
              <div style="font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:700;margin-bottom:6px">Avg Per Billboard</div>
              <div style="font-size:28px;font-weight:800;color:#10b981" id="analyticsAvgRevenue">$0</div>
              <div style="font-size:11px;color:#6b7280;margin-top:4px">monthly rate</div>
            </div>
          </div>
          <!-- Charts Row -->
          <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px">
            <div style="background:#fff;border:2px solid #eef2ff;border-radius:12px;padding:16px">
              <div style="font-size:13px;font-weight:700;color:#374151;margin-bottom:12px">Revenue Trend</div>
              <div style="height:180px;width:100%">
                <canvas id="revenueChart" style="width:100%;height:100%"></canvas>
              </div>
            </div>
            <div style="background:#fff;border:2px solid #eef2ff;border-radius:12px;padding:16px">
              <div style="font-size:13px;font-weight:700;color:#374151;margin-bottom:12px">Status</div>
              <div style="height:180px;display:flex;align-items:center;justify-content:center;width:100%">
                <canvas id="statusChart" style="width:100%;height:100%"></canvas>
              </div>
            </div>
          </div>
          <!-- Top Performers -->
          <div style="background:#fff;border:2px solid #eef2ff;border-radius:12px;padding:16px;margin-top:12px">
            <div style="font-size:13px;font-weight:700;color:#374151;margin-bottom:12px">Top Revenue Generators</div>
            <div id="topBillboards"></div>
          </div>
        </div>

        <!-- Alerts -->
        <div id="dashboardAlerts" class="filterbox" style="margin-top:20px;display:none">
          <h3 style="margin-bottom:12px;font-size:16px;color:#f59e0b">⚠️ Alerts</h3>
          <div id="dashboardAlertsList"></div>
        </div>
      </section>
<!-- API Keys Pane -->
<section id="pane-apikeys" class="pane hidden" role="tabpanel" aria-labelledby="tab-apikeys">
  <div class="filterbox">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <h3 style="margin:0;font-size:18px;font-weight:700">🔑 API Keys</h3>
        <p style="color:#6b7280;font-size:13px;margin:4px 0 0 0">Manage API keys for external integrations</p>
      </div>
      <button class="btn btn-primary" onclick="generateAPIKey()">+ Generate New Key</button>
    </div>

    <!-- API Keys List -->
    <div id="apiKeysList" style="margin-top:16px">
      <div style="color:#6b7280;padding:20px;text-align:center">Loading API keys...</div>
    </div>
  </div>

  <!-- API Documentation -->
  <div class="filterbox" style="margin-top:20px">
    <h3 style="margin-bottom:12px;font-size:16px;font-weight:700">📚 API Documentation</h3>
    <p style="color:#6b7280;margin-bottom:16px">Use these endpoints to integrate with external systems:</p>
    
    <div style="background:#1f2937;padding:16px;border-radius:8px;overflow-x:auto">
      <pre style="color:#e5e7eb;margin:0;font-size:13px;line-height:1.6"><code><span style="color:#10b981"># List Inventory (GET)</span>
GET https://slokdinbenkwkqfoduwq.supabase.co/rest/v1/inventory_production
Headers:
  apikey: YOUR_SUPABASE_ANON_KEY
  Authorization: Bearer YOUR_SUPABASE_ANON_KEY
  x-api-key: YOUR_API_KEY

<span style="color:#10b981"># Filter by country</span>
?country=eq.USA

<span style="color:#10b981"># Filter by active status</span>
?active=eq.true

<span style="color:#10b981"># Pagination</span>
?limit=50&offset=0

<span style="color:#10b981"># Search by name</span>
?board_name=ilike.*Plaza*</code></pre>
    </div>

    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-top:12px;border-left:4px solid #f59e0b">
      <strong style="color:#92400e">⚠️ Important:</strong>
      <p style="color:#92400e;margin:4px 0 0 0;font-size:13px">Keep your API keys secure. Never share them publicly or commit them to version control.</p>
    </div>
  </div>
</section>

              <!-- Analytics Section on Dashboard -->
                <!-- ...existing code... -->

      <!-- Inventory Pane -->
      <section id="pane-inventory" class="pane hidden" role="tabpanel" aria-labelledby="tab-inventory">
        <div class="filterbox" style="margin-bottom:16px">
          <!-- Preset Filters -->
          <div class="preset-filters" style="margin-bottom:10px">
            <button class="preset-filter" onclick="applyPresetFilter('all')">All</button>
            <button class="preset-filter" onclick="applyPresetFilter('available')">Available Only</button>
            <button class="preset-filter" onclick="applyPresetFilter('active')">Active Only</button>
            <button class="preset-filter" onclick="applyPresetFilter('inactive')">Inactive</button>
            <button class="preset-filter" onclick="applyPresetFilter('booked')">Currently Booked</button>
          </div>

          <!-- Bulk Actions Bar -->
          <div id="bulkBar" class="bulk-bar hidden" style="margin-bottom:10px">
            <span id="bulkCount" style="font-weight:600;color:#374151">0 selected</span>
            <button class="btn btn-sm btn-success" onclick="bulkExport()">Export Selected</button>
            <button class="btn btn-sm btn-primary" onclick="bulkActivate()">Activate Selected</button>
            <button class="btn btn-sm btn-secondary" onclick="bulkDeactivate()">Deactivate Selected</button>
            <button class="btn btn-sm btn-danger" onclick="bulkDelete()">Delete Selected</button>
            <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear Selection</button>
          </div>

          <div class="filter-grid" style="margin-bottom:10px">
            <div>
              <label for="searchInput">Search</label>
              <input id="searchInput" type="text" placeholder="Board name, location...">
            </div>
            <div>
              <label for="countryFilter">Country</label>
              <select id="countryFilter"><option value="">All Countries</option></select>
            </div>
            <div>
              <label for="stateFilter">State</label>
              <select id="stateFilter"><option value="">All States</option></select>
            </div>
            <div>
              <label for="typeFilter">Billboard Type</label>
              <select id="typeFilter"><option value="">All Types</option></select>
            </div>
          </div>

          <div class="toggles" style="margin-bottom:10px">
            <label><input type="checkbox" id="activeFilter" checked> Active Only</label>
            <label><input type="checkbox" id="availableFilter" checked> Available Only</label>

            <div class="actions">
              <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
              <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
              <input id="csvFile" type="file" accept=".csv" onchange="handleFileUpload(event)" style="display:none">
              <button class="btn btn-secondary" onclick="downloadCSVTemplate()">Download Template</button>
              <button id="btnList" class="btn btn-secondary" aria-pressed="true" onclick="setView('list')">List</button>
              <button id="btnGrid" class="btn btn-secondary" aria-pressed="false" onclick="setView('grid')">Grid</button>
            </div>
          </div>

          <div id="dropzone" class="dropzone" style="margin-top:10px;margin-bottom:16px">
            <strong>Drop CSV here</strong> or
            <button class="btn btn-secondary" type="button" onclick="document.getElementById('csvFile').click()">Browse</button>
          </div>
        </div>

  <div class="tablewrap" aria-live="polite" style="margin-bottom:16px">
          <div id="loading" class="loading">Loading inventory...</div>

          <table id="inventoryTable" style="display:none">
            <thead>
            <tr>
              <th scope="col" class="checkbox-cell">
                <input type="checkbox" id="selectAll" title="Select all">
              </th>
              <th scope="col">Board Name</th>
              <th scope="col">Location</th>
              <th scope="col">Country</th>
              <th scope="col">State</th>
              <th scope="col">Type</th>
              <th scope="col">Standard Rate</th>
              <th scope="col">Monthly Rate</th>
              <th scope="col">Screens</th>
              <th scope="col">Status</th>
              <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
          </table>

          <div id="inventoryGrid" class="grid hidden"></div>

          <div id="pagination" class="pagination" style="display:none;margin-top:8px">
            <div id="pageInfo" style="color:#64748b"></div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="rowsSelect" class="rows-select">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn btn-secondary" onclick="firstPage()">« First</button>
              <button id="prevBtn" class="btn btn-secondary" onclick="previousPage()">‹ Prev</button>
              <button id="nextBtn" class="btn btn-secondary" onclick="nextPage()">Next ›</button>
              <button class="btn btn-secondary" onclick="lastPage()">Last »</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Map Pane -->
      <section id="pane-map" class="pane hidden" role="tabpanel" aria-labelledby="tab-map">
  <div class="filterbox" style="margin-bottom:16px">
          <h3 style="margin-bottom:6px">Map View</h3>
          <p style="color:#475569;margin-bottom:12px">Visualize billboard locations. Click markers for details.</p>
          <div class="map-legend" style="margin-bottom:16px">
            <h4>Legend</h4>
            <div class="map-legend-item"><div class="dot" style="background:#10b981"></div><span>Active & Available</span></div>
            <div class="map-legend-item"><div class="dot" style="background:#f59e0b"></div><span>Active (Not Available)</span></div>
            <div class="map-legend-item"><div class="dot" style="background:#6b7280"></div><span>Inactive</span></div>
          </div>
        </div>
  <div id="map" style="width:100%;margin-bottom:16px"></div>
      </section>
    </section>
    <!-- Calendar Pane -->
      <section id="pane-calendar" class="pane hidden" role="tabpanel" aria-labelledby="tab-calendar">
        <div class="filterbox">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:16px;margin:0">Booking Calendar</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn btn-secondary btn-sm" onclick="previousMonth()">‹ Prev</button>
              <span id="calendarMonthYear" style="font-weight:600;min-width:150px;text-align:center"></span>
              <button class="btn btn-secondary btn-sm" onclick="nextMonth()">Next ›</button>
              <button class="btn btn-secondary btn-sm" onclick="todayMonth()">Today</button>
            </div>
          </div>

          <!-- Legend -->
          <div style="display:flex;gap:16px;margin-bottom:12px;padding:8px;background:#f9fafb;border-radius:8px">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px">
              <div style="width:12px;height:12px;border-radius:3px;background:#10b981"></div>
              <span>Confirmed</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px">
              <div style="width:12px;height:12px;border-radius:3px;background:#f59e0b"></div>
              <span>Pending</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px">
              <div style="width:12px;height:12px;border-radius:3px;background:#667eea"></div>
              <span>Completed</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px">
              <div style="width:12px;height:12px;border-radius:3px;background:#ef4444"></div>
              <span>Cancelled</span>
            </div>
          </div>
        </div>

        <!-- Calendar Grid -->
        <div style="background:#fff;border:2px solid #eef2ff;border-radius:12px;overflow:hidden">
          <div style="display:grid;grid-template-columns:repeat(7,1fr);background:var(--primary);color:#fff">
            <div style="padding:12px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase">Sun</div>
            <div style="padding:12px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase">Mon</div>
            <div style="padding:12px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase">Tue</div>
            <div style="padding:12px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase">Wed</div>
            <div style="padding:12px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase">Thu</div>
            <div style="padding:12px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase">Fri</div>
            <div style="padding:12px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase">Sat</div>
          </div>
          <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);min-height:500px"></div>
        </div>

        <!-- Day Details Panel -->
        <div id="dayDetailsPanel" class="filterbox hidden" style="margin-top:16px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h4 id="dayDetailsTitle" style="margin:0;font-size:15px"></h4>
            <button class="btn btn-secondary btn-sm" onclick="closeDayDetails()">Close</button>
          </div>
          <div id="dayDetailsContent"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- ====== Add/Edit Modal ====== -->
  <div id="addModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:900;padding:16px">
    <div class="pane" style="max-width:640px;width:100%;background:#fff;border-radius:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <h2 id="modalTitle">Add New Site</h2>
        <button class="btn btn-secondary btn-sm" onclick="closeModal()">Close</button>
      </div>
      <form onsubmit="handleSubmit(event)">
        <div class="form-group"><label for="boardName">Board Name *</label><input id="boardName" required></div>
        <div class="form-group"><label for="displayName">Display Name</label><input id="displayName"></div>
        <div class="form-group"><label for="referenceId">Reference ID</label><input id="referenceId"></div>
        <div class="form-group"><label for="country">Country *</label><input id="country" required></div>
        <div class="form-group"><label for="state">State</label><input id="state"></div>
        <div class="form-group"><label for="district">District</label><input id="district"></div>
        <div class="form-group"><label for="address">Address</label><input id="address"></div>
        <div class="form-group"><label for="billboardType">Billboard Type</label><input id="billboardType"></div>
        <div class="form-group"><label for="standardRate">Standard Rate</label><input id="standardRate" type="number" step="0.01"></div>
        <div class="form-group"><label for="monthlyRate">Monthly Rate</label><input id="monthlyRate" type="number" step="0.01"></div>
        <div class="form-group"><label for="noOfScreens">Number of Screens</label><input id="noOfScreens" type="number"></div>
        <div class="form-group"><label for="latitude">Latitude</label><input id="latitude" type="number" step="any" placeholder="e.g., 6.9271"></div>
        <div class="form-group"><label for="longitude">Longitude</label><input id="longitude" type="number" step="any" placeholder="e.g., 79.8612"></div>
        <div class="form-group"><label for="activeStatus">Active Status</label>
          <select id="activeStatus"><option value="true">Active</option><option value="false">Inactive</option></select>
        </div>
        <div class="form-group"><label for="availableStatus">Availability</label>
          <select id="availableStatus"><option value="true">Available</option><option value="false">Not Available</option></select>
        </div>
        <button id="submitBtn" class="btn btn-primary" type="submit">Add Site</button>
      </form>
    </div>
  </div>

  <!-- Billboard Bookings Modal -->
  <div id="billboardBookingsModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:900;padding:16px;overflow-y:auto">
    <div class="pane" style="max-width:800px;width:100%;background:#fff;border-radius:14px;max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;position:sticky;top:0;background:#fff;padding-bottom:10px;border-bottom:1px solid #e5e7eb">
        <h2 id="billboardBookingsTitle">Billboard Bookings</h2>
        <button class="btn btn-secondary btn-sm" onclick="closeBillboardBookings()">Close</button>
      </div>
      
      <div style="margin-bottom:16px">
        <button class="btn btn-primary" onclick="openNewBookingForm()">+ New Booking</button>
      </div>

      <!-- New Booking Form (hidden initially) -->
      <div id="newBookingForm" class="hidden" style="background:#f9fafb;padding:16px;border-radius:10px;margin-bottom:16px">
        <h3 style="margin-bottom:12px;font-size:16px">Create New Booking</h3>
        <form onsubmit="handleBookingSubmit(event)">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="form-group"><label for="bookingStartDate">Start Date *</label><input id="bookingStartDate" type="date" required></div>
            <div class="form-group"><label for="bookingEndDate">End Date *</label><input id="bookingEndDate" type="date" required></div>
          </div>
          <div class="form-group"><label for="bookingClient">Client Name</label><input id="bookingClient"></div>
          <div class="form-group"><label for="bookingCampaign">Campaign Name</label><input id="bookingCampaign"></div>
          <div class="form-group"><label for="bookingStatus">Status</label>
            <select id="bookingStatus">
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="form-group"><label for="bookingNotes">Notes</label><textarea id="bookingNotes" rows="2" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px"></textarea></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" type="submit">Create Booking</button>
            <button class="btn btn-secondary" type="button" onclick="cancelNewBooking()">Cancel</button>
          </div>
        </form>
      </div>

      <!-- Bookings List -->
      <div id="billboardBookingsList"></div>
    </div>
  </div>

  <script>
    /* ====== Supabase Setup ====== */
    const SUPABASE_URL='https://slokdinbenkwkqfoduwq.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb2tkaW5iZW5rd2txZm9kdXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMTQyMzEsImV4cCI6MjA3NDc5MDIzMX0.gXxq2O2PXtGvShnOxWQmFZByAI8qGWpoMqh5-bXeolg';
    const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

    /* ====== State ====== */
    let currentUser=null;
    let currentPage=1, rowsPerPage=50, filteredCount=0, totalCount=0;
    let lastData=[]; // cache of current page for grid/export
    let viewMode='list'; // 'list' | 'grid'
    let map=null; // Leaflet map instance
    let markers=[]; // Map markers
    let selectedBillboards = new Set(); // Track selected billboard UUIDs
    let editingUuid = null; // edit state
    let searchTimeout = null;

    /* ====== Utils ====== */
    const $=sel=>document.querySelector(sel);
    function show(el){el.classList.remove('hidden')}
    function hide(el){el.classList.add('hidden')}
    function toast(msg,type){const t=$("#toast");t.textContent=msg;t.className='toast'+(type==='error'?' error':'');requestAnimationFrame(()=>t.classList.add('show'));setTimeout(()=>t.classList.remove('show'),2400)}
    function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}
    function fmt(n){return Number(n).toLocaleString()}
    const toNum = v => { const n = parseFloat(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n) ? null : n; };
    const toInt = v => { const n = parseInt(String(v).replace(/[^0-9\-]/g,''),10); return isNaN(n) ? null : n; };
    const toBool = v => {
    // Helper function to highlight invalid fields
    function markFieldInvalid(selector, message) {
      const field = $(selector);
      field.classList.add('error');
      // Remove error styling after user starts typing
      field.addEventListener('input', function removeError() {
        field.classList.remove('error');
        field.removeEventListener('input', removeError);
      }, { once: true });
      toast(message, 'error');
      field.focus();
    }
      if (v === true || v === false) return v;
      const s = String(v||'').trim().toLowerCase();
      return ['true','1','yes','y'].includes(s) ? true : (['false','0','no','n'].includes(s) ? false : false);
    };

    /* ====== Auth (REAL Supabase) ====== */
    async function handleLogin(e){
      e.preventDefault();
      const email = $("#loginEmail").value;
      const password = $("#loginPassword").value;

      const {data, error} = await supabase.auth.signInWithPassword({ email, password });
      if(error){ toast('Login failed: ' + error.message, 'error'); return; }

      // Fetch org & role
      const {data: userOrgs, error: orgErr} = await supabase
        .from('user_organizations')
        .select('*, organizations(*)')
        .eq('user_id', data.user.id);

      if(orgErr){ toast('Org lookup failed: ' + orgErr.message, 'error'); await supabase.auth.signOut(); return; }
      if(!userOrgs || userOrgs.length===0){ toast('No organization assigned', 'error'); await supabase.auth.signOut(); return; }

      currentUser = {
        id: data.user.id,
        email: data.user.email,
        organization: userOrgs[0].organizations,
        organizationId: userOrgs[0].organization_id,
        role: userOrgs[0].role
      };

      $("#userInfo").textContent = `${currentUser.email} (${currentUser.organization.name})`;
      hide($("#loginScreen")); 
      show($("#app"));
      await loadDashboard();
      await loadInventory();
      toast('Welcome!');
      setTab(sessionStorage.getItem('tab') || 'dashboard', true);
    }

    // Logout
    async function handleLogout(){ 
      await supabase.auth.signOut();
      currentUser = null; 
      show($("#loginScreen")); 
      hide($("#app")); 
    }

    /* ====== Tabs ====== */
    function setTab(tab, initial=false){
      sessionStorage.setItem('tab', tab);
      // Hide analytics when leaving dashboard
      const analyticsSection = document.getElementById('dashboardAnalytics');
      if(analyticsSection) {
        if(tab === 'dashboard') {
          analyticsSection.classList.remove('hidden');
        } else {
          analyticsSection.classList.add('hidden');
        }
      }
      ['dashboard','inventory','map','calendar','apikeys'].forEach(t=>{
        document.getElementById(`pane-${t}`).classList.toggle('hidden', t!==tab);
        document.getElementById(`tab-${t}`).setAttribute('aria-selected', String(t===tab));
      });
      if(!initial && tab==='inventory'){ loadInventory(); }
      if(!initial && tab==='map'){ initMap(); }
      if(!initial && tab==='calendar'){ loadCalendar(); }
      if(!initial && tab==='apikeys'){ loadAPIKeys(); }
    }

    /* ====== Stats + Dashboard ====== */
    async function loadStats(){
  if(!currentUser) return;  // ✅ FIXED - now exits when NO user

      const orgId = currentUser.organizationId;

      const total = await supabase
        .from('inventory_production')
        .select('*',{count:'exact',head:true})
        .eq('organization_id', orgId);
      totalCount = total.count||0; 
      $("#kpiTotal").textContent=fmt(totalCount);
      $("#kpiTotalTrend").textContent=totalCount > 0 ? `${totalCount} billboard${totalCount !== 1 ? 's' : ''}` : '';

      const act = await supabase
        .from('inventory_production')
        .select('*',{count:'exact',head:true})
        .eq('active',true)
        .eq('organization_id', orgId);
      const activeCount = act.count||0;
      $("#kpiActive").textContent=fmt(activeCount);
      const activePct = totalCount > 0 ? Math.round((activeCount/totalCount)*100) : 0;
      $("#kpiActivePct").textContent = `${activePct}% of total`;

      const {data:countries} = await supabase
        .from('inventory_production')
        .select('country, state')
        .eq('organization_id', orgId);
      const uniqueCountries=[...new Set((countries||[]).map(r=>r.country))].filter(Boolean).sort();
      const uniqueStates=[...new Set((countries||[]).map(r=>r.state))].filter(Boolean).sort();
      $("#kpiCountries").textContent=uniqueCountries.length;
      $("#kpiStates").textContent=`${uniqueStates.length} state${uniqueStates.length !== 1 ? 's' : ''}`;

      // Fill filters
      const countrySel=$("#countryFilter"); countrySel.innerHTML='<option value="">All Countries</option>';
      uniqueCountries.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;countrySel.appendChild(o);});

      const {data:types} = await supabase
        .from('inventory_production')
        .select('billboard_type')
        .eq('organization_id', orgId);
      const uniqueTypes=[...new Set((types||[]).map(r=>r.billboard_type))].filter(Boolean).sort();
      const typeSel=$("#typeFilter"); typeSel.innerHTML='<option value="">All Types</option>';
      uniqueTypes.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;typeSel.appendChild(o);});

      // Current bookings count for today
      const today = new Date().toISOString().split('T')[0];
      const {count: currentBookingsCount} = await supabase
        .from('bookings')
        .select('*', {count: 'exact', head: true})
        .eq('organization_id', orgId)
        .lte('start_date', today)
        .gte('end_date', today);
      $("#kpiCurrentBookings").textContent = fmt(currentBookingsCount || 0);
      const bookingPct = totalCount > 0 ? Math.round(((currentBookingsCount||0)/totalCount)*100) : 0;
      $("#kpiBookingsPct").textContent = `${bookingPct}% utilization`;
    }

    async function loadDashboard(){
  if(!currentUser) return;  // ✅ FIXED
      await loadStats();

      const orgId = currentUser.organizationId;

      // Load recent bookings
      const {data: recentBookings} = await supabase
        .from('bookings')
        .select('*, inventory_production(board_name)')
        .eq('organization_id', orgId)
        .order('created_at', {ascending: false})
        .limit(5);
      
      const recentContainer = $("#dashboardRecentBookings");
      if(!recentBookings || recentBookings.length === 0){
        recentContainer.innerHTML = '<p style="color:#6b7280;padding:20px;text-align:center;background:#f9fafb;border-radius:8px">No bookings yet</p>';
      } else {
        recentContainer.innerHTML = recentBookings.map(b => `
          <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px;background:#fff">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px">
              <strong style="font-size:14px">${escapeHtml(b.inventory_production?.board_name || 'Billboard')}</strong>
              <span class="booking-status ${b.status}">${b.status}</span>
            </div>
            <div style="font-size:13px;color:#6b7280">
              ${escapeHtml(b.campaign_name || 'No campaign name')} • ${b.start_date} to ${b.end_date}
            </div>
            ${b.client_name ? `<div style="font-size:13px;color:#6b7280">Client: ${escapeHtml(b.client_name)}</div>` : ''}
          </div>
        `).join('');
      }
      
      // Alerts
      const alerts = [];
      const today = new Date().toISOString().split('T')[0];
      const nextWeek = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];

      // Bookings ending soon
      const {data: endingSoon} = await supabase
        .from('bookings')
        .select('*, inventory_production(board_name)')
        .eq('organization_id', orgId)
        .gte('end_date', today)
        .lte('end_date', nextWeek)
        .eq('status', 'confirmed');
      
      if(endingSoon && endingSoon.length > 0){
        alerts.push({
          type: 'warning',
          message: `${endingSoon.length} booking${endingSoon.length !== 1 ? 's' : ''} ending within 7 days`,
          details: endingSoon.map(b => `${b.inventory_production?.board_name} - ${b.end_date}`).join(', ')
        });
      }
      
      // Inactive billboards
      const {count: inactiveCount} = await supabase
        .from('inventory_production')
        .select('*', {count: 'exact', head: true})
        .eq('organization_id', orgId)
        .eq('active', false);
      
      if(inactiveCount > 0){
        alerts.push({
          type: 'info',
          message: `${inactiveCount} inactive billboard${inactiveCount !== 1 ? 's' : ''}`,
          details: 'Consider activating them to increase availability'
        });
      }
      
      const alertsContainer = $("#dashboardAlerts");
      const alertsList = $("#dashboardAlertsList");
      if(alerts.length > 0){
        show(alertsContainer);
        alertsList.innerHTML = alerts.map(a => `
          <div style="padding:12px;background:${a.type === 'warning' ? '#fef3c7' : '#dbeafe'};border-radius:8px;margin-bottom:8px">
            <div style="font-weight:600;margin-bottom:4px">${a.message}</div>
            <div style="font-size:13px;color:#6b7280">${a.details}</div>
          </div>
        `).join('');
      } else {
        hide(alertsContainer);
      }
        // Load analytics
        await loadAnalytics();
      // Show analytics section
      const analyticsSection = document.getElementById('dashboardAnalytics');
      if(analyticsSection) {
        analyticsSection.classList.remove('hidden');
      }
      // Load analytics
      await loadAnalytics();
    }

    /* ====== Inventory ====== */
    function setView(mode){
      viewMode=mode; sessionStorage.setItem('view',mode);
      $("#btnList").setAttribute('aria-pressed', String(mode==='list'));
      $("#btnGrid").setAttribute('aria-pressed', String(mode==='grid'));
      if(mode==='grid'){ $("#inventoryGrid").classList.remove('hidden'); $("#inventoryTable").style.display='none'; initCarousels(); }
      else{ $("#inventoryGrid").classList.add('hidden'); $("#inventoryTable").style.display='table'; }
    }

    function showSkeletons(){
      const loading=$("#loading"); loading.innerHTML='';
      for(let i=0;i<6;i++){const row=document.createElement('div');row.className='skeleton-row';for(let c=0;c<10;c++){const d=document.createElement('div');d.className='sk';row.appendChild(d);}loading.appendChild(row);} 
      loading.style.display='block'; $("#inventoryTable").style.display='none'; $("#inventoryGrid").classList.add('hidden'); $("#pagination").style.display='none';
    }

    async function loadInventory(){
  if(!currentUser) return;  // ✅ FIXED
      showSkeletons();
      const orgId = currentUser.organizationId;
      let q=supabase.from('inventory_production').select('*',{count:'exact'}).eq('organization_id', orgId);
      const s=$("#searchInput").value.trim(); if(s) q=q.or(`board_name.ilike.%${s}%,display_name.ilike.%${s}%,address.ilike.%${s}%,reference_id.ilike.%${s}%,inventory_uuid.ilike.%${s}%`);
      const country=$("#countryFilter").value; if(country) q=q.eq('country',country);
      const state=$("#stateFilter").value; if(state) q=q.eq('state',state);
      const type=$("#typeFilter").value; if(type) q=q.eq('billboard_type',type);
      if($("#activeFilter").checked) q=q.eq('active',true);
      if($("#availableFilter").checked) q=q.eq('available',true);

      const from=(currentPage-1)*rowsPerPage, to=from+rowsPerPage-1;
      const {data,error,count}=await q.range(from,to);
      $("#loading").style.display='none';
      if(error){toast(error.message,'error');return}

      filteredCount=count||0; 
      lastData=data||[];

      displayTable(lastData);
      renderGrid(lastData);
      updatePagination(filteredCount);
      $("#pagination").style.display='flex';

      setView(sessionStorage.getItem('view')||viewMode);
    }

    function displayTable(items){
      const tb=$("#inventoryBody"); tb.innerHTML='';
      if(items.length===0){
        $("#inventoryTable").style.display='table';
        const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=11;td.innerHTML='<div class="loading">No inventory matches your filters.</div>';tr.appendChild(td);tb.appendChild(tr);return;
      }
      items.forEach(item=>{
        const row=document.createElement('tr');
        row.innerHTML=`
          <td class="checkbox-cell">
            <input type="checkbox" class="row-select" data-uuid="${escapeHtml(item.inventory_uuid)}" title="Select row">
          </td>
          <td><strong>${escapeHtml(item.board_name||'-')}</strong></td>
          <td>${escapeHtml(item.address||'-')}</td>
          <td>${escapeHtml(item.country||'-')}</td>
          <td>${escapeHtml(item.state||'-')}</td>
          <td>${escapeHtml(item.billboard_type||'-')}</td>
          <td class="price">${item.selling_standard_rate? '$'+fmt(item.selling_standard_rate):'-'}</td>
          <td class="price">${item.selling_monthly_rate? '$'+fmt(item.selling_monthly_rate):'-'}</td>
          <td>${item.no_of_screens??'-'}</td>
          <td>
            <span class="badge ${item.active?'badge-active':'badge-inactive'}">${item.active?'Active':'Inactive'}</span>
            ${item.available?'<span class="badge badge-available">Available</span>':''}
          </td>
          <td>
            <button class="btn btn-sm btn-secondary"
              onclick="openBillboardBookings('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'')}')">Bookings</button>
            <button class="btn btn-sm btn-primary"
              onclick="openAddModal('${escapeHtml(item.inventory_uuid)}')">Edit</button>
            <button class="btn btn-sm btn-secondary"
              onclick="toggleStatus('${escapeHtml(item.inventory_uuid)}', ${!!item.active}, '${escapeHtml(item.board_name||'')}')">
              ${item.active?'Deactivate':'Activate'}
            </button>
            <button class="btn btn-sm btn-danger"
              onclick="deleteItem('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'')}')">Delete</button>
          </td>`;
        tb.appendChild(row);
      });
      // Wire up row checkboxes & reflect selected state
      document.querySelectorAll('.row-select').forEach(cb=>{
        const uuid = cb.dataset.uuid;
        cb.checked = selectedBillboards.has(uuid);
        cb.addEventListener('change', e=> toggleSelect(uuid, cb.checked));
      });
      // Select-all checkbox behavior
      const selectAll = $("#selectAll");
      selectAll.onchange = (e)=> toggleSelectAll(e.target.checked);
      selectAll.checked = lastData.length>0 && lastData.every(it=>selectedBillboards.has(it.inventory_uuid));

      $("#inventoryTable").style.display='table';
    }

    function renderGrid(items){
      const grid=$("#inventoryGrid"); grid.innerHTML='';
      items.forEach(item=>{
        const urls = String(item.images||'').split(/[,|]/).map(s=>s.trim()).filter(Boolean);
        const card=document.createElement('div'); card.className='card';
        const dots = urls.map((_,i)=>`<span class="dot ${i===0?'active':''}"></span>`).join('');
        card.innerHTML=`
          <div class="carousel">
            ${urls.length? urls.map((u,i)=>`<img src="${escapeHtml(u)}" alt="billboard" class="${i===0?'active':''}">`).join('') : '<img class="active" alt="" src="https://picsum.photos/600/400?random=5">'}
            <div class="dots">${dots}</div>
          </div>
          <div class="card-body">
            <div class="card-title">${escapeHtml(item.display_name||item.board_name||'Billboard')}</div>
            <div class="card-meta">${escapeHtml(item.address||'-')}</div>
            <div class="card-badges">
              <span class="badge ${item.active?'badge-active':'badge-inactive'}">${item.active?'Active':'Inactive'}</span>
              ${item.available?'<span class="badge badge-available">Available</span>':''}
              <span class="badge" style="background:#f3f4f6;color:#111827">${escapeHtml(item.billboard_type||'Type')}</span>
            </div>
            <div style="margin-top:8px">
              <strong class="price">${item.selling_standard_rate? '$'+fmt(item.selling_standard_rate):'-'}</strong>
              <span style="color:#6b7280"> std • </span>
              <strong class="price">${item.selling_monthly_rate? '$'+fmt(item.selling_monthly_rate):'-'}</strong>
              <span style="color:#6b7280">/mo</span>
            </div>
            <div class="card-actions">
              <button class="btn btn-sm btn-secondary"
                onclick="openBillboardBookings('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'Billboard')}')">Bookings</button>
              <button class="btn btn-sm btn-primary"
                onclick="openAddModal('${escapeHtml(item.inventory_uuid)}')">Edit</button>
              <button class="btn btn-sm btn-danger"
                onclick="deleteItem('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'')}')">Delete</button>
            </div>
          </div>`;
        grid.appendChild(card);
      });
      initCarousels();
    }

    function initCarousels(){
      document.querySelectorAll('.carousel').forEach(car=>{
        const imgs=[...car.querySelectorAll('img')]; if(imgs.length<2) return;
        const dots=[...car.querySelectorAll('.dot')]; let idx=0;
        setInterval(()=>{ imgs[idx].classList.remove('active'); dots[idx]?.classList.remove('active'); idx=(idx+1)%imgs.length; imgs[idx].classList.add('active'); dots[idx]?.classList.add('active'); }, 3000);
      });
    }

    function updatePagination(total){
      const totalPages=Math.max(1, Math.ceil(total/rowsPerPage));
      const from=(total===0)?0:(currentPage-1)*rowsPerPage+1;
      const to=Math.min(currentPage*rowsPerPage,total);
      $("#pageInfo").textContent=`Showing ${from}-${to} of ${fmt(total)} (Page ${currentPage} of ${totalPages})`;
      $("#prevBtn").disabled=currentPage===1; $("#nextBtn").disabled=currentPage>=totalPages;
      sessionStorage.setItem('page', String(currentPage));
      sessionStorage.setItem('rows', String(rowsPerPage));
    }

    function applyFilters(){ currentPage=1; loadInventory(); }
    function resetFilters(){ $("#searchInput").value=''; $("#countryFilter").value=''; $("#stateFilter").value=''; $("#typeFilter").value=''; $("#activeFilter").checked=true; $("#availableFilter").checked=true; currentPage=1; loadInventory(); }
    function firstPage(){ if(currentPage!==1){ currentPage=1; loadInventory(); } }
    function previousPage(){ if(currentPage>1){ currentPage--; loadInventory(); } }
    function nextPage(){ const totalPages=Math.max(1,Math.ceil(filteredCount/rowsPerPage)); if(currentPage<totalPages){ currentPage++; loadInventory(); } }
    function lastPage(){ const totalPages=Math.max(1,Math.ceil(filteredCount/rowsPerPage)); if(currentPage!==totalPages){ currentPage=totalPages; loadInventory(); } }

    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id === 'rowsSelect'){
        rowsPerPage=parseInt(e.target.value,10)||50; currentPage=1; loadInventory();
      }
    });

    // Country → State cascade
    document.addEventListener('change', async (e)=>{
      if(e.target && e.target.id === 'countryFilter'){
        const country=e.target.value; const stateSel=$("#stateFilter");
        stateSel.innerHTML='<option value="">All States</option>';
        if(!country) return;
        const {data:states}=await supabase.from('inventory_production').select('state').eq('country',country).eq('organization_id', currentUser.organizationId);
        [...new Set((states||[]).map(r=>r.state))].filter(Boolean).sort().forEach(s=>{
          const o=document.createElement('option');o.value=s;o.textContent=s;stateSel.appendChild(o);
        });
      }
    });

    /* ====== CRUD ====== */
    function openAddModal(uuid = null){
      editingUuid = uuid;
      if(uuid){
        // Edit mode
        $("#modalTitle").textContent = 'Edit Billboard';
        $("#submitBtn").textContent = 'Update Billboard';
        const item = lastData.find(i => i.inventory_uuid === uuid);
        if(!item) return toast('Billboard not found', 'error');
        $("#boardName").value = item.board_name || '';
        $("#displayName").value = item.display_name || '';
        $("#referenceId").value = item.reference_id || '';
        $("#country").value = item.country || '';
        $("#state").value = item.state || '';
        $("#district").value = item.district || '';
        $("#address").value = item.address || '';
        $("#billboardType").value = item.billboard_type || '';
        $("#standardRate").value = item.selling_standard_rate || '';
        $("#monthlyRate").value = item.selling_monthly_rate || '';
        $("#noOfScreens").value = item.no_of_screens || '';
        $("#activeStatus").value = String(item.active);
        $("#availableStatus").value = String(item.available);
        $("#latitude").value = item.latitude ?? '';
        $("#longitude").value = item.longitude ?? '';
      } else {
        // Add mode
        $("#modalTitle").textContent = 'Add New Site';
        $("#submitBtn").textContent = 'Add Site';
        const form = $("#addModal form"); form.reset();
        $("#activeStatus").value = 'true';
        $("#availableStatus").value = 'true';
        $("#latitude").value = '';
        $("#longitude").value = '';
      }
      show($("#addModal"));
      setTimeout(() => $("#boardName").focus(), 0);
    }
    function closeModal(){
      hide($("#addModal"));
      const form = $("#addModal form"); if(form) form.reset();
      editingUuid = null;
    }

    async function handleSubmit(e){
      e.preventDefault();
      
      // ===== VALIDATION SECTION =====
      
      // 1. Board Name validation
      const boardName = $("#boardName").value.trim();
      if(!boardName){
        $("#boardName").focus();
        return toast('Billboard name is required', 'error');
      }
      if(boardName.length < 3){
        $("#boardName").focus();
        return toast('Billboard name must be at least 3 characters', 'error');
      }
      if(boardName.length > 100){
        $("#boardName").focus();
        return toast('Billboard name must be less than 100 characters', 'error');
      }

      // 2. Country validation
      const country = $("#country").value.trim();
      if(!country){
        $("#country").focus();
        return toast('Country is required', 'error');
      }

      // 3. GPS Coordinates validation
      const lat = toNum($("#latitude").value);
      const lng = toNum($("#longitude").value);

      // If one is provided, both must be provided
      if((lat !== null && lng === null) || (lat === null && lng !== null)){
        return toast('Both latitude and longitude are required for GPS coordinates', 'error');
      }

      if(lat !== null && (lat < -90 || lat > 90)){
        $("#latitude").focus();
        return toast('Latitude must be between -90 and 90', 'error');
      }
      if(lng !== null && (lng < -180 || lng > 180)){
        $("#longitude").focus();
        return toast('Longitude must be between -180 and 180', 'error');
      }

      // 4. Pricing validation
      const standardRate = toNum($("#standardRate").value);
      const monthlyRate = toNum($("#monthlyRate").value);

      if(standardRate !== null && standardRate < 0){
        $("#standardRate").focus();
        return toast('Standard rate cannot be negative', 'error');
      }
      if(monthlyRate !== null && monthlyRate < 0){
        $("#monthlyRate").focus();
        return toast('Monthly rate cannot be negative', 'error');
      }
      if(standardRate !== null && standardRate > 1000000){
        $("#standardRate").focus();
        return toast('Standard rate seems unreasonably high. Please verify.', 'error');
      }
      if(monthlyRate !== null && monthlyRate > 1000000){
        $("#monthlyRate").focus();
        return toast('Monthly rate seems unreasonably high. Please verify.', 'error');
      }

      // 5. Number of Screens validation
      const noOfScreens = toInt($("#noOfScreens").value);
      if(noOfScreens !== null && noOfScreens < 1){
        $("#noOfScreens").focus();
        return toast('Number of screens must be at least 1', 'error');
      }
      if(noOfScreens !== null && noOfScreens > 100){
        $("#noOfScreens").focus();
        return toast('Number of screens seems too high. Please verify.', 'error');
      }

      // ===== END VALIDATION =====

      // Original data collection (now using trimmed values)
      const data = {
        board_name: boardName,
        display_name: $("#displayName").value.trim(),
        reference_id: $("#referenceId").value.trim(),
        country: country,
        state: $("#state").value.trim(),
        district: $("#district").value.trim(),
        address: $("#address").value.trim(),
        billboard_type: $("#billboardType").value.trim(),
        selling_standard_rate: standardRate,
        selling_monthly_rate: monthlyRate,
        no_of_screens: noOfScreens,
        active: $("#activeStatus").value === 'true',
        available: $("#availableStatus").value === 'true',
        latitude: lat,
        longitude: lng,
        gps_coordinates: (lat != null && lng != null) ? `${lat},${lng}` : null
      };
      
      // Rest of your original submit logic stays the same
      let error;
      if(editingUuid){
        const result = await supabase
          .from('inventory_production')
          .update(data)
          .eq('inventory_uuid', editingUuid)
          .eq('organization_id', currentUser.organizationId);
        error = result.error;
      } else {
        data.inventory_uuid = 'INV-' + Date.now();
        data.organization_id = currentUser.organizationId;
        const result = await supabase.from('inventory_production').insert([data]);
        error = result.error;
      }
      
      if(error) return toast(error.message, 'error');
      
      toast(editingUuid ? 'Billboard updated' : 'Site added');
      editingUuid = null;
      closeModal();
      await loadDashboard();
      await loadInventory();
    }

    async function toggleStatus(uuid, currentStatus, boardName){
      const newStatus=!currentStatus; const statusText=newStatus?'Active':'Inactive';
      if(!confirm(`Change "${boardName}" to ${statusText}?`)) return;
      const {data,error}=await supabase.from('inventory_production').update({active:newStatus}).eq('inventory_uuid',uuid).eq('organization_id', currentUser.organizationId).select();
      if(error) return toast(error.message,'error');
      if(data&&data.length){ toast(`Changed to ${statusText}`); await loadDashboard(); await loadInventory(); }
      else toast('No rows updated','error');
    }

    async function deleteItem(uuid,name){
      if(!confirm(`Delete ${name}?`)) return;
      const {error}=await supabase.from('inventory_production').delete().eq('inventory_uuid',uuid).eq('organization_id', currentUser.organizationId);
      if(error) return toast('Delete failed','error');
      toast('Deleted'); await loadDashboard(); await loadInventory();
    }

    /* ====== CSV & Export ====== */
    const dz=$("#dropzone");
    ['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();dz.classList.add('drag')}));
    ['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();dz.classList.remove('drag')}));
    dz.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if (f) handleFileUpload({ target: { files: [f] } });
    });

    function downloadCSVTemplate(){
      const template=`inventory_uuid,board_name,display_name,reference_id,country,state,district,address,latitude,longitude,gps_coordinates,media_owner,active,available,billboard_type,board_format,images,selling_standard_rate,selling_monthly_rate,no_of_screens,resolution,programmatic_enabled,exposure_to_dsp
INV-SAMPLE-001,Downtown Billboard,Main Street Digital,REF-001,USA,California,Los Angeles,123 Main St,34.0522,-118.2437,"34.0522,-118.2437",ABC Media,true,true,Digital,Landscape,https://example.com/img1.jpg|https://example.com/img2.jpg,5000,15000,1,1920x1080,Yes,Yes`;
      const blob=new Blob([template],{type:'text/csv'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='inventory_template.csv'; a.click(); URL.revokeObjectURL(a.href); toast('Template downloaded');
    }

    function handleFileUpload(e){
      const file=e.target.files?.[0]; if(!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        transformHeader: h => String(h||'').trim(),
        complete: async function(results){
          if (!results || !Array.isArray(results.data)) { toast('CSV parse failed','error'); return; }

          const rows = results.data;

          const items = rows.map((row, i) => {
            const r = (k) => row[k] ?? '';
            return {
              inventory_uuid: r('inventory_uuid') || ('INV-' + Date.now() + '-' + i),
              organization_id: currentUser.organizationId,
              board_name: r('board_name') || '',
              display_name: r('display_name') || r('board_name') || '',
              reference_id: r('reference_id') || '',
              country: r('country') || '',
              state: r('state') || '',
              district: r('district') || '',
              address: r('address') || '',
              latitude: toNum(r('latitude')),
              longitude: toNum(r('longitude')),
              gps_coordinates: r('gps_coordinates') || '',
              media_owner: r('media_owner') || '',
              active: toBool(r('active')),
              available: toBool(r('available')),
              billboard_type: r('billboard_type') || '',
              board_format: r('board_format') || '',
              images: r('images') || '',
              selling_standard_rate: toNum(r('selling_standard_rate')),
              selling_monthly_rate: toNum(r('selling_monthly_rate')),
              no_of_screens: toInt(r('no_of_screens')),
              resolution: r('resolution') || '',
              programmatic_enabled: r('programmatic_enabled') || 'No',
              exposure_to_dsp: r('exposure_to_dsp') || 'No'
            };
          }).filter(x => x.board_name || x.display_name || x.address);

          if(!items.length) return toast('No valid rows','error');
          if(!confirm(`Upload ${items.length} items?`)) return;

          let uploaded=0; const batch=100;
          for(let i=0;i<items.length;i+=batch){
            const {error}=await supabase.from('inventory_production').insert(items.slice(i,i+batch));
            if(error){ toast(error.message,'error'); break; }
            uploaded+=Math.min(batch, items.length-i);
          }
          toast(`Uploaded ${uploaded}`);
          $("#csvFile").value='';
          await loadDashboard();
          await loadInventory();
        },
        error: function(err){ toast('CSV error: '+err.message,'error'); }
      });
    }

    /* ====== Map ====== */
    async function initMap(){
  if(!currentUser) return;  // ✅ FIXED

      if(!map){
        map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
      }

      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const {data, error} = await supabase
        .from('inventory_production')
        .select('*')
        .eq('organization_id', currentUser.organizationId)
        .not('latitude', 'is', null)
        .not('longitude', 'is', null);

      if(error){ toast('Failed to load map data', 'error'); return; }
      if(!data || data.length === 0){ toast('No billboards with GPS coordinates', 'error'); return; }

      const bounds = [];
      data.forEach(item => {
        const lat = parseFloat(item.latitude);
        const lng = parseFloat(item.longitude);
        if(Number.isNaN(lat) || Number.isNaN(lng)) return;

        bounds.push([lat, lng]);
        let color = '#6b7280';
        if(item.active && item.available) color = '#10b981';
        else if(item.active) color = '#f59e0b';

        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background:${color};width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });

        const popupContent = `
          <div class="map-popup">
            <h3>${escapeHtml(item.board_name || 'Billboard')}</h3>
            <div class="detail"><span class="label">Location:</span><span>${escapeHtml(item.address || '-')}</span></div>
            <div class="detail"><span class="label">Type:</span><span>${escapeHtml(item.billboard_type || '-')}</span></div>
            <div class="detail"><span class="label">Standard Rate:</span><span class="price">${item.selling_standard_rate ? '$'+fmt(item.selling_standard_rate) : '-'}</span></div>
            <div class="detail"><span class="label">Monthly Rate:</span><span class="price">${item.selling_monthly_rate ? '$'+fmt(item.selling_monthly_rate) : '-'}</span></div>
            <div class="detail"><span class="label">Status:</span><span><span class="badge ${item.active?'badge-active':'badge-inactive'}">${item.active?'Active':'Inactive'}</span>${item.available?'<span class="badge badge-available">Available</span>':''}</span></div>
          </div>`;

        const marker = L.marker([lat, lng], {icon}).addTo(map);
        marker.bindPopup(popupContent);
        markers.push(marker);
      });

      if(bounds.length > 0){ map.fitBounds(bounds, {padding: [50, 50]}); }
      toast(`Showing ${data.length} billboards on map`);
    }

    /* ====== Bookings ====== */
    let currentBillboardForBooking = null;

    function openBillboardBookings(inventoryUuid, boardName){
      currentBillboardForBooking = inventoryUuid;
      $("#billboardBookingsTitle").textContent = `Bookings: ${boardName}`;
      show($("#billboardBookingsModal"));
      hide($("#newBookingForm"));
      loadBillboardBookings();
    }

    function closeBillboardBookings(){
      hide($("#billboardBookingsModal"));
      currentBillboardForBooking = null;
    }

    function openNewBookingForm(){
      show($("#newBookingForm"));
      const today = new Date().toISOString().split('T')[0];
      $("#bookingStartDate").value = today;
      const nextWeek = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
      $("#bookingEndDate").value = nextWeek;
    }

    function cancelNewBooking(){
      hide($("#newBookingForm"));
      $("#newBookingForm form").reset();
    }

    async function loadBillboardBookings(){
      if(!currentBillboardForBooking) return;
      
      const {data, error} = await supabase
        .from('bookings')
        .select('*')
        .eq('inventory_uuid', currentBillboardForBooking)
        .eq('organization_id', currentUser.organizationId)
        .order('start_date', {ascending: false});
      
      if(error){ toast('Failed to load bookings', 'error'); return; }
      
      const list = $("#billboardBookingsList");
      if(!data || data.length === 0){
        list.innerHTML = '<p style="color:#6b7280;padding:20px;text-align:center;background:#f9fafb;border-radius:8px">No bookings yet. Click "New Booking" to create one.</p>';
        return;
      }
      
      list.innerHTML = data.map(b => `
        <div class="booking-card">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
            <h4 style="margin:0">${escapeHtml(b.campaign_name || 'Booking')}</h4>
            <span class="booking-status ${b.status}">${b.status}</span>
          </div>
          <div class="meta">📅 <strong>${b.start_date}</strong> to <strong>${b.end_date}</strong></div>
          <div class="meta">👤 Client: ${escapeHtml(b.client_name || 'Not specified')}</div>
          ${b.notes ? `<div class="meta" style="margin-top:6px;padding:8px;background:#f9fafb;border-radius:6px">📝 ${escapeHtml(b.notes)}</div>` : ''}
          <div style="margin-top:10px;display:flex;gap:6px">
            <button class="btn btn-sm btn-danger" onclick="deleteBooking('${b.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    async function handleBookingSubmit(e){
      e.preventDefault();
      
      // ===== VALIDATION SECTION =====
      
      // 1. Date validation
      const startDate = $("#bookingStartDate").value;
      const endDate = $("#bookingEndDate").value;
      
      if(!startDate || !endDate){
        return toast('Both start and end dates are required', 'error');
      }

      const start = new Date(startDate);
      const end = new Date(endDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // End date cannot be before start date
      if(end < start){
        $("#bookingEndDate").focus();
        return toast('End date cannot be before start date', 'error');
      }

      // Warn if booking is in the past
      if(start < today){
        const confirm = window.confirm(
          '⚠️ Warning: Start date is in the past.\n\n' +
          'Are you sure you want to create a historical booking?'
        );
        if(!confirm) return;
      }

      // Warn if booking is very long (more than 1 year)
      const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
      if(daysDiff > 365){
        const confirm = window.confirm(
          `⚠️ Warning: This booking is ${daysDiff} days long (over 1 year).\n\n` +
          'Are you sure this is correct?'
        );
        if(!confirm) return;
      }

      // 2. Client name validation (optional but recommended)
      const clientName = $("#bookingClient").value.trim();
      if(clientName && clientName.length < 2){
        $("#bookingClient").focus();
        return toast('Client name must be at least 2 characters', 'error');
      }

      // 3. Campaign name validation (optional but recommended)
      const campaignName = $("#bookingCampaign").value.trim();
      if(campaignName && campaignName.length < 2){
        $("#bookingCampaign").focus();
        return toast('Campaign name must be at least 2 characters', 'error');
      }

      // ===== END VALIDATION =====
      
      // Check for conflicts (your existing code)
      const {data: conflicts, error: conflictError} = await supabase
        .from('bookings')
        .select('*')
        .eq('inventory_uuid', currentBillboardForBooking)
        .eq('organization_id', currentUser.organizationId)
        .neq('status', 'cancelled')
        .lte('start_date', endDate)
        .gte('end_date', startDate);
        
      if(conflictError){ console.error('Conflict check error:', conflictError); }
      
      if(conflicts && conflicts.length > 0){
        const conflictList = conflicts.map(c => 
          `${c.campaign_name || 'Untitled'}: ${c.start_date} to ${c.end_date}`
        ).join('\n');
        if(!confirm(`⚠️ CONFLICT DETECTED\n\nThis billboard has ${conflicts.length} overlapping booking(s):\n\n${conflictList}\n\nCreate booking anyway?`)){
          return;
        }
      }

      // Create booking (your existing code, now using trimmed values)
      const booking = {
        inventory_uuid: currentBillboardForBooking,
        organization_id: currentUser.organizationId,
        start_date: startDate,
        end_date: endDate,
        client_name: clientName || null,
        campaign_name: campaignName || null,
        status: $("#bookingStatus").value,
        notes: $("#bookingNotes").value.trim() || null,
        created_by: currentUser.id
      };
      
      const {error} = await supabase.from('bookings').insert([booking]);
      if(error){ toast(error.message, 'error'); return; }
      
      toast('Booking created successfully');
      cancelNewBooking();
      loadBillboardBookings();
      loadDashboard();
    }

    async function deleteBooking(id){
      if(!confirm('Delete this booking? This cannot be undone.')) return;
      const {error} = await supabase.from('bookings').delete().eq('id', id).eq('organization_id', currentUser.organizationId);
      if(error){ toast('Delete failed', 'error'); return; }
      toast('Booking deleted');
      loadBillboardBookings();
      loadDashboard();
    }

    /* ====== Misc ====== */
    /* ====== Analytics ====== */
        let revenueChart = null;
        let statusChart = null;

        async function loadAnalytics(){

          if(!currentUser) return;
          // Guard: Only run if analytics section exists and is visible
          const analyticsSection = document.getElementById('dashboardAnalytics');
          if(!analyticsSection || analyticsSection.offsetParent === null) return;

          const orgId = currentUser.organizationId;
          const today = new Date();
          const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
          const lastOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

          // Get all bookings
          const {data: allBookings} = await supabase
            .from('bookings')
            .select('*, inventory_production(selling_monthly_rate, board_name)')
            .eq('organization_id', orgId);

          // Revenue MTD
          const mtdBookings = (allBookings || []).filter(b => 
            b.start_date <= lastOfMonth && b.end_date >= firstOfMonth && b.status !== 'cancelled'
          );
          const revenueMTD = mtdBookings.reduce((sum, b) => {
            const rate = b.inventory_production?.selling_monthly_rate || 0;
            return sum + rate;
          }, 0);
          $("#analyticsRevenueMTD").textContent = '$' + fmt(revenueMTD);
          $("#analyticsRevenueTrend").textContent = `${mtdBookings.length} active bookings`;

          // Occupancy rate
          const todayStr = today.toISOString().split('T')[0];
          const occupiedToday = (allBookings || []).filter(b => 
            b.start_date <= todayStr && b.end_date >= todayStr && b.status === 'confirmed'
          ).length;
          const occupancyRate = totalCount > 0 ? Math.round((occupiedToday / totalCount) * 100) : 0;
          $("#analyticsOccupancy").textContent = occupancyRate + '%';
          $("#analyticsOccupancyDetail").textContent = `${occupiedToday} of ${totalCount} booked`;

          // Average revenue per billboard
          const avgRevenue = totalCount > 0 ? Math.round(revenueMTD / totalCount) : 0;
          $("#analyticsAvgRevenue").textContent = '$' + fmt(avgRevenue);

          // Revenue by month chart
          const monthlyRevenue = {};
          for(let i = 2; i >= 0; i--){ // Only last 3 months
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const monthKey = d.toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
            const firstDay = new Date(d.getFullYear(), d.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).toISOString().split('T')[0];
            const revenue = (allBookings || []).filter(b => 
              b.start_date <= lastDay && b.end_date >= firstDay && b.status !== 'cancelled'
            ).reduce((sum, b) => sum + (b.inventory_production?.selling_monthly_rate || 0), 0);
            monthlyRevenue[monthKey] = revenue;
          }

          renderRevenueChart(monthlyRevenue);

          // Status chart
          const statusCounts = {
            confirmed: (allBookings || []).filter(b => b.status === 'confirmed').length,
            pending: (allBookings || []).filter(b => b.status === 'pending').length,
            completed: (allBookings || []).filter(b => b.status === 'completed').length,
            cancelled: (allBookings || []).filter(b => b.status === 'cancelled').length
          };
          renderStatusChart(statusCounts);

          // Top performing billboards
          const billboardRevenue = {};
          (allBookings || []).forEach(b => {
            if(b.status === 'cancelled') return;
            const name = b.inventory_production?.board_name || 'Unknown';
            const rate = b.inventory_production?.selling_monthly_rate || 0;
            billboardRevenue[name] = (billboardRevenue[name] || 0) + rate;
          });
      
          const topBillboards = Object.entries(billboardRevenue)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);
      
          renderTopBillboards(topBillboards);
        }

        function renderRevenueChart(data){
          const ctx = document.getElementById('revenueChart');
          if(!ctx) return;
      
          if(revenueChart) revenueChart.destroy();
      
          revenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: Object.keys(data),
              datasets: [{
                label: 'Revenue',
                data: Object.values(data),
                backgroundColor: '#667eea',
                borderRadius: 3,
                barThickness: 16,
                maxBarThickness: 18,
                minBarLength: 2
              }]
            },
            options: {
            responsive: false,
            maintainAspectRatio: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { font: { size: 11 }, maxRotation: 0, minRotation: 0 }
                },
                y: {
                  grid: { display: false },
                  beginAtZero: true,
                  ticks: {
                    font: { size: 11 },
                    callback: function(value) { return '$' + value.toLocaleString(); }
                  }
                }
              }
            }
          });
        }

        function renderStatusChart(data){
          const ctx = document.getElementById('statusChart');
          if(!ctx) return;
      
          if(statusChart) statusChart.destroy();
      
          statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['Confirmed', 'Pending', 'Completed', 'Cancelled'],
              datasets: [{
                data: [data.confirmed, data.pending, data.completed, data.cancelled],
                backgroundColor: ['#10b981', '#f59e0b', '#667eea', '#ef4444'],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }

        function renderTopBillboards(data){
          const container = $("#topBillboards");
          if(!container) return;
      
          if(data.length === 0){
            container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No revenue data yet</p>';
            return;
          }
      
          container.innerHTML = data.map(([name, revenue], i) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #e5e7eb;font-size:14px">
              <div style="display:flex;align-items:center;gap:12px">
                <span style="font-size:18px;font-weight:800;color:#6b7280">#${i+1}</span>
                <span style="font-weight:600">${escapeHtml(name)}</span>
              </div>
              <span style="font-size:18px;font-weight:800;color:#10b981">$${fmt(revenue)}</span>
            </div>
          `).join('');
        }
    function syncNow(){ loadDashboard(); loadInventory(); toast('Synced'); }

    window.addEventListener('load', ()=>{
      const savedRows=parseInt(sessionStorage.getItem('rows')||'50',10); rowsPerPage=isNaN(savedRows)?50:savedRows; $("#rowsSelect").value=String(savedRows);
      const savedView=sessionStorage.getItem('view'); if(savedView) viewMode=savedView;
      const savedPage=parseInt(sessionStorage.getItem('page')||'1',10); if(!isNaN(savedPage)) currentPage=savedPage;
    });

    /* ====== Bulk Actions (fixed) ====== */
    function toggleSelect(uuid, checked){
      if(checked) selectedBillboards.add(uuid);
      else selectedBillboards.delete(uuid);
      updateBulkBar();
      $("#selectAll").checked = lastData.length>0 && lastData.every(it=>selectedBillboards.has(it.inventory_uuid));
    }

    function toggleSelectAll(checked){
      if(checked){ lastData.forEach(item => selectedBillboards.add(item.inventory_uuid)); }
      else{ lastData.forEach(item => selectedBillboards.delete(item.inventory_uuid)); }
      document.querySelectorAll('.row-select').forEach(cb=>{ cb.checked = checked; });
      updateBulkBar();
    }

    function updateBulkBar(){
      const count = selectedBillboards.size;
      const bar = $("#bulkBar");
      const countEl = $("#bulkCount");
      if(count > 0){ bar.classList.remove('hidden'); countEl.textContent = `${count} selected`; }
      else{ bar.classList.add('hidden'); }
    }

    function clearSelection(){
      selectedBillboards.clear();
      const selAll=$("#selectAll"); if(selAll) selAll.checked=false;
      document.querySelectorAll('.row-select').forEach(cb=> cb.checked=false);
      updateBulkBar();
    }

    async function bulkActivate(){
      if(selectedBillboards.size === 0) return toast('No billboards selected', 'error');
      if(!confirm(`Activate ${selectedBillboards.size} billboard(s)?`)) return;
      const {error} = await supabase.from('inventory_production').update({active: true}).in('inventory_uuid', Array.from(selectedBillboards));
      if(error) return toast(error.message, 'error');
      toast(`Activated ${selectedBillboards.size} billboard(s)`);
      clearSelection(); loadStats(); loadInventory();
    }

    async function bulkDeactivate(){
      if(selectedBillboards.size === 0) return toast('No billboards selected', 'error');
      if(!confirm(`Deactivate ${selectedBillboards.size} billboard(s)?`)) return;
      const {error} = await supabase.from('inventory_production').update({active: false}).in('inventory_uuid', Array.from(selectedBillboards));
      if(error) return toast(error.message, 'error');
      toast(`Deactivated ${selectedBillboards.size} billboard(s)`);
      clearSelection(); loadStats(); loadInventory();
    }

    async function bulkDelete(){
      if(selectedBillboards.size === 0) return toast('No billboards selected', 'error');
      if(!confirm(`DELETE ${selectedBillboards.size} billboard(s)? This cannot be undone!`)) return;
      const {error} = await supabase.from('inventory_production').delete().in('inventory_uuid', Array.from(selectedBillboards));
      if(error) return toast('Delete failed', 'error');
      toast(`Deleted ${selectedBillboards.size} billboard(s)`);
      clearSelection(); loadStats(); loadInventory();
    }

    async function bulkExport(){
      if(selectedBillboards.size === 0) return toast('No billboards selected', 'error');
      const selectedData = lastData.filter(item => selectedBillboards.has(item.inventory_uuid));
      const headers = ["Board Name", "Location", "Country", "State", "Type", "Standard Rate", "Monthly Rate", "Screens", "Active", "Available"];
      const rows = selectedData.map(i => [
        i.board_name || '',
        i.address || '',
        i.country || '',
        i.state || '',
        i.billboard_type || '',
        i.selling_standard_rate ?? '',
        i.selling_monthly_rate ?? '',
        i.no_of_screens ?? '',
        i.active ? 'Yes' : 'No',
        i.available ? 'Yes' : 'No'
      ]);
      const csv = [headers, ...rows].map(r => r.map(x => '"' + String(x).replace(/"/g, '""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'selected_inventory_' + Date.now() + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('Exported ' + selectedBillboards.size + ' billboard(s)');
    }

    function exportCurrentView(){
      if(!lastData || lastData.length === 0) return toast('No data to export', 'error');
      const headers = ["Board Name", "Location", "Country", "State", "Type", "Standard Rate", "Monthly Rate", "Screens", "Active", "Available"];
      const rows = lastData.map(i => [
        i.board_name || '',
        i.address || '',
        i.country || '',
        i.state || '',
        i.billboard_type || '',
        i.selling_standard_rate ?? '',
        i.selling_monthly_rate ?? '',
        i.no_of_screens ?? '',
        i.active ? 'Yes' : 'No',
        i.available ? 'Yes' : 'No'
      ]);
      const csv = [headers, ...rows].map(r => r.map(x => '"' + String(x).replace(/"/g, '""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'inventory_export_' + Date.now() + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('Exported ' + lastData.length + ' items');
    }

    function applyPresetFilter(kind){
      if(kind==='all'){ $("#activeFilter").checked=false; $("#availableFilter").checked=false; }
      if(kind==='available'){ $("#activeFilter").checked=false; $("#availableFilter").checked=true; }
      if(kind==='active'){ $("#activeFilter").checked=true; $("#availableFilter").checked=false; }
      if(kind==='inactive'){ $("#activeFilter").checked=false; $("#availableFilter").checked=false; $("#typeFilter").value=''; }
      if(kind==='booked'){ /* reserved for date-overlap filter if needed */ }
      currentPage=1; loadInventory();
    }

    /* ====== Calendar ====== */
    let currentCalendarDate = new Date();
    let allBookingsForCalendar = [];

    async function loadCalendar(){
  if(!currentUser) return;  // ✅ FIXED

      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      $("#calendarMonthYear").textContent = currentCalendarDate.toLocaleDateString('en-US', {month: 'long', year: 'numeric'});

      // Fetch all bookings for this month and adjacent months
      const firstDay = new Date(year, month - 1, 1).toISOString().split('T')[0];
      const lastDay = new Date(year, month + 2, 0).toISOString().split('T')[0];

      const {data: bookings, error} = await supabase
        .from('bookings')
        .select('*, inventory_production(board_name)')
        .eq('organization_id', currentUser.organizationId)
        .gte('end_date', firstDay)
        .lte('start_date', lastDay)
        .order('start_date', {ascending: true});

      if(error){ toast('Failed to load bookings', 'error'); return; }
      
      allBookingsForCalendar = bookings || [];
      renderCalendar();
    }

    function renderCalendar(){
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);
      const startingDayOfWeek = firstDayOfMonth.getDay();
      const daysInMonth = lastDayOfMonth.getDate();

      const grid = $("#calendarGrid");
      grid.innerHTML = '';

      const today = new Date().toISOString().split('T')[0];

      // Previous month days
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for(let i = startingDayOfWeek - 1; i >= 0; i--){
        const day = prevMonthLastDay - i;
        const dateStr = new Date(year, month - 1, day).toISOString().split('T')[0];
        grid.appendChild(createDayCell(day, dateStr, true));
      }

      // Current month days
      for(let day = 1; day <= daysInMonth; day++){
        const dateStr = new Date(year, month, day).toISOString().split('T')[0];
        const isToday = dateStr === today;
        grid.appendChild(createDayCell(day, dateStr, false, isToday));
      }

      // Next month days
      const totalCells = grid.children.length;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for(let day = 1; day <= remainingCells; day++){
        const dateStr = new Date(year, month + 1, day).toISOString().split('T')[0];
        grid.appendChild(createDayCell(day, dateStr, true));
      }
    }

    function createDayCell(day, dateStr, otherMonth, isToday = false){
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      if(otherMonth) cell.classList.add('other-month');
      if(isToday) cell.classList.add('today');
      
      const dayBookings = allBookingsForCalendar.filter(b => 
        dateStr >= b.start_date && dateStr <= b.end_date
      );

      const displayLimit = 3;
      const hasMore = dayBookings.length > displayLimit;

      cell.innerHTML = `
        <div class="calendar-day-number">${day}</div>
        ${dayBookings.slice(0, displayLimit).map(b => {
          const boardName = b.inventory_production?.board_name || 'Billboard';
          return `<div class="calendar-booking ${b.status}" title="${escapeHtml(boardName)} - ${b.campaign_name || 'No name'}">${escapeHtml(boardName.substring(0, 15))}</div>`;
        }).join('')}
        ${hasMore ? `<div class="calendar-booking-count">+${dayBookings.length - displayLimit} more</div>` : ''}
      `;

      cell.onclick = () => showDayDetails(dateStr, dayBookings);
      return cell;
    }

    function showDayDetails(dateStr, bookings){
      const panel = $("#dayDetailsPanel");
      const date = new Date(dateStr + 'T12:00:00');
      $("#dayDetailsTitle").textContent = date.toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
      
      const content = $("#dayDetailsContent");
      if(bookings.length === 0){
        content.innerHTML = '<p style="color:#6b7280;padding:20px;text-align:center">No bookings on this day</p>';
      } else {
        content.innerHTML = bookings.map(b => `
          <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px;border-left:4px solid ${getStatusColor(b.status)}">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px">
              <strong style="font-size:14px">${escapeHtml(b.inventory_production?.board_name || 'Billboard')}</strong>
              <span class="booking-status ${b.status}">${b.status}</span>
            </div>
            <div style="font-size:13px;color:#6b7280">
              ${escapeHtml(b.campaign_name || 'No campaign name')}
            </div>
            <div style="font-size:12px;color:#6b7280;margin-top:4px">
              ${b.start_date} to ${b.end_date}
            </div>
            ${b.client_name ? `<div style="font-size:12px;color:#6b7280">Client: ${escapeHtml(b.client_name)}</div>` : ''}
          </div>
        `).join('');
      }
      
      panel.classList.remove('hidden');
      panel.scrollIntoView({behavior: 'smooth', block: 'nearest'});
    }

    function closeDayDetails(){
      $("#dayDetailsPanel").classList.add('hidden');
    }

    function getStatusColor(status){
      const colors = {confirmed: '#10b981', pending: '#f59e0b', completed: '#667eea', cancelled: '#ef4444'};
      return colors[status] || '#6b7280';
    }

    function previousMonth(){
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      loadCalendar();
    }

    function nextMonth(){
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      loadCalendar();
    }

    function todayMonth(){
      currentCalendarDate = new Date();
      loadCalendar();
    }
  // Expose to window
  window.previousMonth=previousMonth;
  window.nextMonth=nextMonth;
  window.todayMonth=todayMonth;
  window.closeDayDetails=closeDayDetails;

  /* ====== API Key Management ====== */
  async function loadAPIKeys(){
  if(!currentUser) return;  // ✅ FIXED
  
    const {data, error} = await supabase
      .from('api_keys')
      .select('*')
      .eq('organization_id', currentUser.organizationId)
      .order('created_at', {ascending: false});
  
    if(error){
      toast(error.message, 'error');
      return;
    }
  
    const list = $('#apiKeysList');
  
    if(!data || data.length === 0){
      list.innerHTML = `
        <div style="text-align:center;padding:40px;background:#f9fafb;border-radius:8px;border:2px dashed #e5e7eb">
          <div style="font-size:48px;margin-bottom:12px">🔑</div>
          <h4 style="margin:0 0 8px 0;color:#111827">No API Keys Yet</h4>
          <p style="color:#6b7280;margin:0 0 16px 0">Generate your first API key to start integrating with external systems</p>
          <button class="btn btn-primary" onclick="generateAPIKey()">Generate API Key</button>
        </div>
      `;
      return;
    }
  
    list.innerHTML = data.map(key => {
      const createdDate = new Date(key.created_at).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'});
      const lastUsed = key.last_used_at 
        ? new Date(key.last_used_at).toLocaleString('en-US', {year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})
        : 'Never';
    
      return `
        <div style="border:2px solid #e5e7eb;border-radius:10px;padding:16px;margin-bottom:12px;background:#fff">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <strong style="font-size:15px">${escapeHtml(key.key_name)}</strong>
                <span class="badge ${key.is_active ? 'badge-active' : 'badge-inactive'}" style="font-size:10px">
                  ${key.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <div style="font-size:12px;color:#6b7280">
                Created: ${createdDate} • Last used: ${lastUsed}
              </div>
            </div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-sm btn-secondary" onclick="copyAPIKey('${escapeHtml(key.api_key)}')">📋 Copy</button>
              <button class="btn btn-sm btn-danger" onclick="revokeAPIKey('${key.id}', '${escapeHtml(key.key_name)}')">Revoke</button>
            </div>
          </div>
          <div style="background:#f9fafb;padding:10px;border-radius:6px;font-family:monospace;font-size:12px;color:#374151;overflow-x:auto">
            ${escapeHtml(key.api_key.substring(0, 20))}••••••••••••••••••••
          </div>
        </div>
      `;
    }).join('');
  }

  async function generateAPIKey(){
    const keyName = prompt('Enter a name for this API key:\n(e.g., "Production API", "LMX Integration", "Testing")');
    if(!keyName || !keyName.trim()) return;
  
    showLoading();
  
    // Generate secure random key
    const randomBytes = new Uint8Array(32);
    crypto.getRandomValues(randomBytes);
    const apiKey = 'sk_' + Array.from(randomBytes)
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  
    const {data, error} = await supabase.from('api_keys').insert([{
      organization_id: currentUser.organizationId,
      key_name: keyName.trim(),
      api_key: apiKey,
      is_active: true
    }]).select().single();
  
    hideLoading();
  
    if(error){
      toast(error.message, 'error');
      return;
    }
  
    // Show the key in a modal (one-time view)
    const copyBtn = `<button onclick="copyToClipboard('${apiKey}')" style="padding:8px 16px;background:#10b981;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-top:12px">📋 Copy to Clipboard</button>`;
  
    const confirmed = confirm(
      `✅ API Key Generated Successfully!\n\n` +
      `Key: ${apiKey}\n\n` +
      `⚠️ IMPORTANT: Copy this key now! You won't be able to see it again.\n\n` +
      `Click OK to copy to clipboard.`
    );
  
    if(confirmed){
      copyToClipboard(apiKey);
      toast('API key copied to clipboard!');
    }
  
    loadAPIKeys();
  }

  async function revokeAPIKey(id, name){
    if(!confirm(`Revoke API key "${name}"?\n\nThis will immediately stop all API requests using this key. This action cannot be undone.`)) return;
  
    const {error} = await supabase
      .from('api_keys')
      .delete()
      .eq('id', id)
      .eq('organization_id', currentUser.organizationId);
  
    if(error){
      toast(error.message, 'error');
      return;
    }
  
    toast('API key revoked successfully');
    loadAPIKeys();
  }

  function copyAPIKey(apiKey){
    copyToClipboard(apiKey);
    toast('Full API key copied to clipboard!');
  }

  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text);
    } else {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }
  }

  // Expose functions to window
  window.loadAPIKeys = loadAPIKeys;
  window.generateAPIKey = generateAPIKey;
  window.revokeAPIKey = revokeAPIKey;
  window.copyAPIKey = copyAPIKey;
    window.applyFilters=applyFilters; window.resetFilters=resetFilters; window.exportCurrentView=exportCurrentView;
    window.openAddModal=openAddModal; window.closeModal=closeModal;
    window.toggleStatus=toggleStatus; window.deleteItem=deleteItem;
    window.firstPage=firstPage; window.previousPage=previousPage; window.nextPage=nextPage; window.lastPage=lastPage;
    window.downloadCSVTemplate=downloadCSVTemplate; window.syncNow=syncNow;
    window.setView=setView; window.setTab=setTab; window.handleLogin=handleLogin; window.handleLogout=handleLogout;

    // bookings
    window.openBillboardBookings=openBillboardBookings;
    window.closeBillboardBookings=closeBillboardBookings;
    window.openNewBookingForm=openNewBookingForm;
    window.cancelNewBooking=cancelNewBooking;
    window.handleBookingSubmit=handleBookingSubmit;
    window.deleteBooking=deleteBooking;

    function showLoading(){ show($("#loadingOverlay")); }
    function hideLoading(){ hide($("#loadingOverlay")); }
  </script>
</body>
</html>


