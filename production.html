<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>InventoryHub - Production System</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Leaflet (Map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* ====== Design Tokens ====== */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#667eea; --primary-700:#5568d3; --accent:#764ba2;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --bg:#f6f7fb; --card:#fff; --soft:#f1f5f9; --text:#111827; --muted:#6b7280;
      --radius:12px;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    :focus-visible{outline:2px solid var(--primary);outline-offset:2px;border-radius:8px}
    .hidden{display:none!important}

    /* ====== Login ====== */
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--primary),var(--accent));padding:24px}
    .login-box{width:100%;max-width:420px;background:var(--card);padding:38px;border-radius:var(--radius);
      box-shadow:0 18px 40px rgba(0,0,0,.2)}
    .login-box h1{font-size:28px;margin-bottom:8px}
    .login-box p{color:var(--muted);margin-bottom:18px}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:#374151}
    .form-group input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px}
    .form-group input:focus{border-color:var(--primary)}
    .login-btn{width:100%;padding:13px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:800;cursor:pointer}
    .login-btn:hover{background:var(--primary-700)}
    .demo-note{margin-top:12px;padding:10px;background:#fff7d6;border-radius:8px;color:#8a5a00;font-size:13px}

    /* ====== App Shell ====== */
    .app{max-width:1200px;margin:0 auto;padding:18px}
    .brandbar{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;border-radius:14px;
      padding:18px 20px;margin:18px 0;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brandbar h1{font-size:22px;margin-bottom:4px}
    .brandbar small{opacity:.9}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-700)}
    .btn-secondary{background:#eef2ff}.btn-secondary:hover{background:#e0e7ff}
    .btn-success{background:var(--ok);color:#fff}
    .btn-warning{background:var(--warn);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-sm{padding:6px 10px;font-size:12px}
    .logout-btn{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.5)}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{background:#fff;border:1.5px solid #e5e7eb;color:#111827;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
    .tab[aria-selected="true"]{border-color:#c7d2fe;background:#eef2ff}
    .tabpanes{background:var(--card);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .pane{padding:16px}

    /* Toast */
    .toast{position:fixed;top:18px;right:18px;background:var(--ok);color:#fff;padding:12px 16px;border-radius:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);opacity:0;transform:translateY(-8px);transition:all .25s;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)} .toast.error{background:var(--danger)}

    /* KPIs */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:8px 0 2px}
    .stat{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:16px;position:relative}
    .stat .dot{position:absolute;right:12px;top:12px;width:8px;height:8px;border-radius:999px;background:var(--primary)}
    .stat .label{font-size:12px;text-transform:uppercase;color:#6b7280;font-weight:800;letter-spacing:.04em}
    .stat .value{font-size:26px;font-weight:800;color:#111827;margin-top:6px}

    /* Filters & Actions */
    .filterbox{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:16px;margin:12px 0}
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:10px}
    .filter-grid label{font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:800;margin-bottom:4px;display:block}
    .filter-grid input,.filter-grid select{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px}
    .toggles{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}

    /* Dropzone */
    .dropzone{border:2px dashed #c7d2fe;background:#eef2ff;border-radius:12px;padding:14px;text-align:center;color:#1e3a8a}
    .dropzone.drag{background:#e0e7ff;border-color:var(--primary)}

    /* Table */
    .tablewrap{background:#fff;border:1px solid #eef2ff;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead{background:var(--primary);color:#fff}
    th{padding:14px;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
    td{padding:12px 14px;border-bottom:1px solid #f1f5f9}
    tbody tr:hover{background:#f8f9ff}
    .price{font-weight:800;color:var(--ok)}
    .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800}
    .badge-active{background:#d1fae5;color:#065f46}
    .badge-inactive{background:#fee2e2;color:#991b1b}
    .badge-available{background:#dbeafe;color:#1e40af}

    /* Pagination */
    .pagination{display:flex;justify-content:space-between;align-items:center;padding:14px;background:#fafafa}
    .rows-select{padding:8px 10px;border:2px solid #e5e7eb;border-radius:8px}

    /* Grid Cards + Carousel */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .carousel{position:relative;height:140px;background:#e5e7eb}
    .carousel img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}
    .carousel img.active{display:block}
    .carousel .dots{position:absolute;bottom:8px;left:0;right:0;display:flex;gap:6px;justify-content:center}
    .carousel .dot{width:7px;height:7px;border-radius:999px;background:rgba(255,255,255,.8)}
    .carousel .dot.active{background:#fff}
    .card-body{padding:12px 14px}
    .card-title{font-weight:800;margin-bottom:4px}
    .card-meta{font-size:13px;color:#4b5563}
    .card-badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .card-actions{display:flex;gap:6px;margin-top:10px}

    /* Loading skeleton */
    .loading{padding:28px;text-align:center;color:#6b7280}
    .skeleton-row{display:grid;grid-template-columns:2fr 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;gap:12px;padding:12px 14px}
    .sk{height:14px;border-radius:6px;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:sk 1.1s linear infinite}
    @keyframes sk{0%{background-position:0 0}100%{background-position:-200% 0}}

    /* ====== Map ====== */
    #map{height:500px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    .leaflet-popup-content-wrapper{border-radius:10px;padding:0}
    .leaflet-popup-content{margin:0;width:280px!important}
    .map-popup{padding:12px}
    .map-popup h3{font-size:16px;margin-bottom:8px;color:#111827}
    .map-popup .detail{display:flex;justify-content:space-between;margin:4px 0;font-size:13px}
    .map-popup .detail .label{color:#6b7280;font-weight:600}
    .map-legend{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-top:10px}
    .map-legend h4{font-size:13px;font-weight:800;margin-bottom:8px;text-transform:uppercase;color:#374151}
    .map-legend-item{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:13px}
    .map-legend-item .dot{width:12px;height:12px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.1)}

    /* ====== Calendar / Bookings ====== */
    .calendar-container{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-top:12px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
    .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:14px;cursor:pointer;position:relative}
    .calendar-day.header{font-weight:800;cursor:default;color:#6b7280;font-size:12px}
    .calendar-day.disabled{color:#d1d5db;cursor:not-allowed}
    .calendar-day.today{border:2px solid var(--primary)}
    .calendar-day.booked{background:#fee2e2;color:#991b1b}
    .calendar-day.available{background:#d1fae5;color:#065f46}
    .calendar-day:hover:not(.header):not(.disabled){background:#f3f4f6}
    .booking-list{margin-top:16px}
    .booking-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-bottom:10px}
    .booking-card h4{margin-bottom:6px;font-size:15px}
    .booking-card .meta{font-size:13px;color:#6b7280;margin:4px 0}
    .booking-status{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:800;text-transform:uppercase}
    .booking-status.pending{background:#fef3c7;color:#92400e}
    .booking-status.confirmed{background:#d1fae5;color:#065f46}
    .booking-status.completed{background:#e0e7ff;color:#3730a3}
    .booking-status.cancelled{background:#fee2e2;color:#991b1b}
  </style>
</head>
<body>
  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ====== Login ====== -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <h1>InventoryHub</h1>
      <p>Billboard Inventory Management System</p>
      <form onsubmit="handleLogin(event)">
        <div class="form-group"><label>Email Address</label><input type="email" id="loginEmail" required placeholder="you@company.com"/></div>
        <div class="form-group"><label>Password</label><input type="password" id="loginPassword" required placeholder="••••••••"/></div>
        <button class="login-btn" type="submit">Login</button>
      </form>
      <div class="demo-note"><strong>Note:</strong> This screen uses real Supabase authentication.</div>
    </div>
  </div>

  <!-- ====== App ====== -->
  <div id="app" class="app hidden">
    <div class="brandbar">
      <div>
        <h1>InventoryHub</h1>
        <small id="userInfo">Signed in</small>
      </div>
      <div class="top-actions" role="toolbar" aria-label="Quick actions">
        <button class="btn btn-secondary" onclick="syncNow()">Sync</button>
        <button class="btn btn-secondary" onclick="exportCurrentView()">Export CSV</button>
        <button class="btn btn-success" onclick="document.getElementById('csvFile').click()">Bulk Upload</button>
        <button class="btn btn-warning" onclick="openAddModal()">Add Billboard</button>
        <button class="btn logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Primary navigation">
      <button id="tab-dashboard" class="tab" role="tab" aria-selected="true" onclick="setTab('dashboard')">Dashboard</button>
      <button id="tab-inventory" class="tab" role="tab" aria-selected="false" onclick="setTab('inventory')">Inventory</button>
      <button id="tab-map" class="tab" role="tab" aria-selected="false" onclick="setTab('map')">Map View</button>
      <!-- Bookings tab removed -->
    </div>

    <!-- Panes -->
    <div class="tabpanes">
      <!-- Dashboard Pane -->
      <section id="pane-dashboard" class="pane" role="tabpanel" aria-labelledby="tab-dashboard">
        <div class="stats">
          <div class="stat"><span class="dot" aria-hidden="true"></span><div class="label">Total Billboards</div><div class="value" id="kpiTotal">-</div></div>
          <div class="stat"><span class="dot" aria-hidden="true"></span><div class="label">Filtered Results</div><div class="value" id="kpiFiltered">-</div></div>
          <div class="stat"><span class="dot" aria-hidden="true"></span><div class="label">Active Sites</div><div class="value" id="kpiActive">-</div></div>
          <div class="stat"><span class="dot" aria-hidden="true"></span><div class="label">Countries</div><div class="value" id="kpiCountries">-</div></div>
        </div>

        <div class="filterbox" style="margin-top:14px">
          <p style="color:#475569">Welcome! Use the <strong>Inventory</strong> tab to manage billboards, or open <strong>Map View</strong> to visualize locations.</p>
        </div>
      </section>

      <!-- Inventory Pane -->
      <section id="pane-inventory" class="pane hidden" role="tabpanel" aria-labelledby="tab-inventory">
        <div class="filterbox">
          <div class="filter-grid">
            <div>
              <label for="searchInput">Search</label>
              <input id="searchInput" type="text" placeholder="Board name, location...">
            </div>
            <div>
              <label for="countryFilter">Country</label>
              <select id="countryFilter"><option value="">All Countries</option></select>
            </div>
            <div>
              <label for="stateFilter">State</label>
              <select id="stateFilter"><option value="">All States</option></select>
            </div>
            <div>
              <label for="typeFilter">Billboard Type</label>
              <select id="typeFilter"><option value="">All Types</option></select>
            </div>
          </div>

          <div class="toggles">
            <label><input type="checkbox" id="activeFilter" checked> Active Only</label>
            <label><input type="checkbox" id="availableFilter" checked> Available Only</label>

            <div class="actions">
              <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
              <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
              <input id="csvFile" type="file" accept=".csv,.xlsx" onchange="handleFileUpload(event)" style="display:none">
              <button class="btn btn-secondary" onclick="downloadCSVTemplate()">Download Template</button>
              <button id="btnList" class="btn btn-secondary" aria-pressed="true" onclick="setView('list')">List</button>
              <button id="btnGrid" class="btn btn-secondary" aria-pressed="false" onclick="setView('grid')">Grid</button>
            </div>
          </div>

          <div id="dropzone" class="dropzone" style="margin-top:10px">
            <strong>Drop CSV here</strong> or
            <button class="btn btn-secondary" type="button" onclick="document.getElementById('csvFile').click()">Browse</button>
          </div>
        </div>

        <div class="tablewrap" aria-live="polite">
          <div id="loading" class="loading">Loading inventory...</div>

          <table id="inventoryTable" style="display:none">
            <thead>
            <tr>
              <th scope="col">Board Name</th>
              <th scope="col">Location</th>
              <th scope="col">Country</th>
              <th scope="col">State</th>
              <th scope="col">Type</th>
              <th scope="col">Standard Rate</th>
              <th scope="col">Monthly Rate</th>
              <th scope="col">Screens</th>
              <th scope="col">Status</th>
              <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
          </table>

          <div id="inventoryGrid" class="grid hidden"></div>

          <div id="pagination" class="pagination" style="display:none">
            <div id="pageInfo" style="color:#64748b"></div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="rowsSelect" class="rows-select">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button class="btn btn-secondary" onclick="firstPage()">« First</button>
              <button id="prevBtn" class="btn btn-secondary" onclick="previousPage()">‹ Prev</button>
              <button id="nextBtn" class="btn btn-secondary" onclick="nextPage()">Next ›</button>
              <button class="btn btn-secondary" onclick="lastPage()">Last »</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Map Pane -->
      <section id="pane-map" class="pane hidden" role="tabpanel" aria-labelledby="tab-map">
        <div class="filterbox">
          <h3 style="margin-bottom:6px">Map View</h3>
          <p style="color:#475569;margin-bottom:12px">Visualize billboard locations. Click markers for details.</p>
          <div class="map-legend">
            <h4>Legend</h4>
            <div class="map-legend-item"><div class="dot" style="background:#10b981"></div><span>Active & Available</span></div>
            <div class="map-legend-item"><div class="dot" style="background:#f59e0b"></div><span>Active (Not Available)</span></div>
            <div class="map-legend-item"><div class="dot" style="background:#6b7280"></div><span>Inactive</span></div>
          </div>
        </div>
        <div id="map"></div>
      </section>
    </div>
  </div>

  <!-- ====== Add/Edit Modal ====== -->
  <div id="addModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:900;padding:16px">
    <div class="pane" style="max-width:640px;width:100%;background:#fff;border-radius:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <h2 id="modalTitle">Add New Site</h2>
        <button class="btn btn-secondary btn-sm" onclick="closeModal()">Close</button>
      </div>
      <form onsubmit="handleSubmit(event)">
        <div class="form-group"><label for="boardName">Board Name *</label><input id="boardName" required></div>
        <div class="form-group"><label for="displayName">Display Name</label><input id="displayName"></div>
        <div class="form-group"><label for="referenceId">Reference ID</label><input id="referenceId"></div>
        <div class="form-group"><label for="country">Country *</label><input id="country" required></div>
        <div class="form-group"><label for="state">State</label><input id="state"></div>
        <div class="form-group"><label for="district">District</label><input id="district"></div>
        <div class="form-group"><label for="address">Address</label><input id="address"></div>
        <div class="form-group"><label for="billboardType">Billboard Type</label><input id="billboardType"></div>
        <div class="form-group"><label for="standardRate">Standard Rate</label><input id="standardRate" type="number" step="0.01"></div>
        <div class="form-group"><label for="monthlyRate">Monthly Rate</label><input id="monthlyRate" type="number" step="0.01"></div>
        <div class="form-group"><label for="noOfScreens">Number of Screens</label><input id="noOfScreens" type="number"></div>
        <div class="form-group"><label for="activeStatus">Active Status</label>
          <select id="activeStatus"><option value="true">Active</option><option value="false">Inactive</option></select>
        </div>
        <div class="form-group"><label for="availableStatus">Availability</label>
          <select id="availableStatus"><option value="true">Available</option><option value="false">Not Available</option></select>
        </div>
        <button id="submitBtn" class="btn btn-primary" type="submit">Add Site</button>
      </form>
    </div>
  </div>

  <!-- Billboard Bookings Modal -->
  <div id="billboardBookingsModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:900;padding:16px;overflow-y:auto">
    <div class="pane" style="max-width:800px;width:100%;background:#fff;border-radius:14px;max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;position:sticky;top:0;background:#fff;padding-bottom:10px;border-bottom:1px solid #e5e7eb">
        <h2 id="billboardBookingsTitle">Billboard Bookings</h2>
        <button class="btn btn-secondary btn-sm" onclick="closeBillboardBookings()">Close</button>
      </div>
      
      <div style="margin-bottom:16px">
        <button class="btn btn-primary" onclick="openNewBookingForm()">+ New Booking</button>
      </div>

      <!-- New Booking Form (hidden initially) -->
      <div id="newBookingForm" class="hidden" style="background:#f9fafb;padding:16px;border-radius:10px;margin-bottom:16px">
        <h3 style="margin-bottom:12px;font-size:16px">Create New Booking</h3>
        <form onsubmit="handleBookingSubmit(event)">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="form-group"><label for="bookingStartDate">Start Date *</label><input id="bookingStartDate" type="date" required></div>
            <div class="form-group"><label for="bookingEndDate">End Date *</label><input id="bookingEndDate" type="date" required></div>
          </div>
          <div class="form-group"><label for="bookingClient">Client Name</label><input id="bookingClient"></div>
          <div class="form-group"><label for="bookingCampaign">Campaign Name</label><input id="bookingCampaign"></div>
          <div class="form-group"><label for="bookingStatus">Status</label>
            <select id="bookingStatus">
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="form-group"><label for="bookingNotes">Notes</label><textarea id="bookingNotes" rows="2" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px"></textarea></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" type="submit">Create Booking</button>
            <button class="btn btn-secondary" type="button" onclick="cancelNewBooking()">Cancel</button>
          </div>
        </form>
      </div>

      <!-- Bookings List -->
      <div id="billboardBookingsList"></div>
    </div>
  </div>

  <script>
    /* ====== Supabase Setup ====== */
    const SUPABASE_URL='https://slokdinbenkwkqfoduwq.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb2tkaW5iZW5rd2txZm9kdXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMTQyMzEsImV4cCI6MjA3NDc5MDIzMX0.gXxq2O2PXtGvShnOxWQmFZByAI8qGWpoMqh5-bXeolg';
    const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

    /* ====== State ====== */
    let currentUser=null;
    let currentPage=1, rowsPerPage=50, filteredCount=0, totalCount=0;
    let lastData=[]; // cache of current page for grid/export
    let viewMode='list'; // 'list' | 'grid'
    let map=null; // Leaflet map instance
    let markers=[]; // Map markers

    /* ====== Utils ====== */
    const $=sel=>document.querySelector(sel);
    function show(el){el.classList.remove('hidden')}
    function hide(el){el.classList.add('hidden')}
    function toast(msg,type){const t=$("#toast");t.textContent=msg;t.className='toast'+(type==='error'?' error':'');requestAnimationFrame(()=>t.classList.add('show'));setTimeout(()=>t.classList.remove('show'),2400)}
    function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
    function fmt(n){return Number(n).toLocaleString()}

    /* ====== Auth (REAL Supabase) ====== */
    async function handleLogin(e){
      e.preventDefault();
      const email = $("#loginEmail").value;
      const password = $("#loginPassword").value;

      const {data, error} = await supabase.auth.signInWithPassword({ email, password });
      if(error){ toast('Login failed: ' + error.message, 'error'); return; }

      // Fetch org & role
      const {data: userOrgs, error: orgErr} = await supabase
        .from('user_organizations')
        .select('*, organizations(*)')
        .eq('user_id', data.user.id);

      if(orgErr){ toast('Org lookup failed: ' + orgErr.message, 'error'); await supabase.auth.signOut(); return; }
      if(!userOrgs || userOrgs.length===0){ toast('No organization assigned', 'error'); await supabase.auth.signOut(); return; }

      currentUser = {
        id: data.user.id,
        email: data.user.email,
        organization: userOrgs[0].organizations,
        organizationId: userOrgs[0].organization_id,
        role: userOrgs[0].role
      };

      $("#userInfo").textContent = `${currentUser.email} (${currentUser.organization.name})`;
      hide($("#loginScreen")); 
      show($("#app"));
      loadStats(); 
      loadInventory(); 
      toast('Welcome!');
      setTab(sessionStorage.getItem('tab') || 'dashboard', true);
    }

    // Logout
    async function handleLogout(){ 
      await supabase.auth.signOut();
      currentUser = null; 
      show($("#loginScreen")); 
      hide($("#app")); 
    }

    /* ====== Tabs ====== */
    function setTab(tab, initial=false){
      sessionStorage.setItem('tab', tab);
      ['dashboard','inventory','map'].forEach(t=>{
        document.getElementById(`pane-${t}`).classList.toggle('hidden', t!==tab);
        document.getElementById(`tab-${t}`).setAttribute('aria-selected', String(t===tab));
      });
      if(!initial && tab==='inventory'){ loadInventory(); }
      if(!initial && tab==='map'){ initMap(); }
    }

    /* ====== Stats ====== */
    async function loadStats(){
      const total = await supabase.from('inventory_production').select('*',{count:'exact',head:true});
      totalCount = total.count||0; $("#kpiTotal").textContent=fmt(totalCount);

      const act = await supabase.from('inventory_production').select('*',{count:'exact',head:true}).eq('active',true);
      $("#kpiActive").textContent=fmt(act.count||0);

      const {data:countries} = await supabase.from('inventory_production').select('country');
      const uniqueCountries=[...new Set((countries||[]).map(r=>r.country))].filter(Boolean).sort();
      $("#kpiCountries").textContent=uniqueCountries.length;

      // Fill filters
      const countrySel=$("#countryFilter"); countrySel.innerHTML='<option value="">All Countries</option>';
      uniqueCountries.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;countrySel.appendChild(o);});

      const {data:types} = await supabase.from('inventory_production').select('billboard_type');
      const uniqueTypes=[...new Set((types||[]).map(r=>r.billboard_type))].filter(Boolean).sort();
      const typeSel=$("#typeFilter"); typeSel.innerHTML='<option value="">All Types</option>';
      uniqueTypes.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;typeSel.appendChild(o);});
    }

    $("#countryFilter").addEventListener('change', async e=>{
      const country=e.target.value; const stateSel=$("#stateFilter");
      stateSel.innerHTML='<option value="">All States</option>';
      if(!country) return;
      const {data:states}=await supabase.from('inventory_production').select('state').eq('country',country);
      [...new Set((states||[]).map(r=>r.state))].filter(Boolean).sort().forEach(s=>{
        const o=document.createElement('option');o.value=s;o.textContent=s;stateSel.appendChild(o);
      });
    });

    /* ====== Inventory ====== */
    function setView(mode){
      viewMode=mode; sessionStorage.setItem('view',mode);
      $("#btnList").setAttribute('aria-pressed', String(mode==='list'));
      $("#btnGrid").setAttribute('aria-pressed', String(mode==='grid'));
      if(mode==='grid'){ $("#inventoryGrid").classList.remove('hidden'); $("#inventoryTable").style.display='none'; initCarousels(); }
      else{ $("#inventoryGrid").classList.add('hidden'); $("#inventoryTable").style.display='table'; }
    }

    function showSkeletons(){
      const loading=$("#loading"); loading.innerHTML='';
      for(let i=0;i<6;i++){const row=document.createElement('div');row.className='skeleton-row';for(let c=0;c<10;c++){const d=document.createElement('div');d.className='sk';row.appendChild(d);}loading.appendChild(row);} 
      loading.style.display='block'; $("#inventoryTable").style.display='none'; $("#inventoryGrid").classList.add('hidden'); $("#pagination").style.display='none';
    }

    async function loadInventory(){
      showSkeletons();
      let q=supabase.from('inventory_production').select('*',{count:'exact'});
      const s=$("#searchInput").value.trim(); if(s) q=q.or(`board_name.ilike.%${s}%,display_name.ilike.%${s}%,address.ilike.%${s}%,reference_id.ilike.%${s}%,inventory_uuid.ilike.%${s}%`);
      const country=$("#countryFilter").value; if(country) q=q.eq('country',country);
      const state=$("#stateFilter").value; if(state) q=q.eq('state',state);
      const type=$("#typeFilter").value; if(type) q=q.eq('billboard_type',type);
      if($("#activeFilter").checked) q=q.eq('active',true);
      if($("#availableFilter").checked) q=q.eq('available',true);

      const from=(currentPage-1)*rowsPerPage, to=from+rowsPerPage-1;
      const {data,error,count}=await q.range(from,to);
      $("#loading").style.display='none';
      if(error){toast(error.message,'error');return}

      filteredCount=count||0; $("#kpiFiltered").textContent=fmt(filteredCount);
      lastData=data||[];

      displayTable(lastData);
      renderGrid(lastData);
      updatePagination(filteredCount);
      $("#pagination").style.display='flex';

      setView(sessionStorage.getItem('view')||viewMode);
    }

    function displayTable(items){
      const tb=$("#inventoryBody"); tb.innerHTML='';
      if(items.length===0){
        $("#inventoryTable").style.display='table';
        const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=10;td.innerHTML='<div class="loading">No inventory matches your filters.</div>';tr.appendChild(td);tb.appendChild(tr);return;
      }
      items.forEach(item=>{
        const row=document.createElement('tr');
        row.innerHTML=`
          <td><strong>${escapeHtml(item.board_name||'-')}</strong></td>
          <td>${escapeHtml(item.address||'-')}</td>
          <td>${escapeHtml(item.country||'-')}</td>
          <td>${escapeHtml(item.state||'-')}</td>
          <td>${escapeHtml(item.billboard_type||'-')}</td>
          <td class="price">${item.selling_standard_rate? '$'+fmt(item.selling_standard_rate):'-'}</td>
          <td class="price">${item.selling_monthly_rate? '$'+fmt(item.selling_monthly_rate):'-'}</td>
          <td>${item.no_of_screens??'-'}</td>
          <td>
            <span class="badge ${item.active?'badge-active':'badge-inactive'}">${item.active?'Active':'Inactive'}</span>
            ${item.available?'<span class="badge badge-available">Available</span>':''}
          </td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="openBillboardBookings('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'')}')">Bookings</button>
            <button class="btn btn-sm btn-primary" onclick="toggleStatus('${escapeHtml(item.inventory_uuid)}', ${!!item.active}, '${escapeHtml(item.board_name||'')}')">${item.active?'Mark Inactive':'Mark Active'}</button>
            <button class="btn btn-sm btn-danger" onclick="deleteItem('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'')}')">Delete</button>
          </td>`;
        tb.appendChild(row);
      });
      $("#inventoryTable").style.display='table';
    }

    function renderGrid(items){
      const grid=$("#inventoryGrid"); grid.innerHTML='';
      items.forEach(item=>{
        const urls = String(item.images||'').split(/[,|]/).map(s=>s.trim()).filter(Boolean);
        const card=document.createElement('div'); card.className='card';
        const dots = urls.map((_,i)=>`<span class="dot ${i===0?'active':''}"></span>`).join('');
        card.innerHTML=`
          <div class="carousel">
            ${urls.length? urls.map((u,i)=>`<img src="${escapeHtml(u)}" alt="billboard" class="${i===0?'active':''}">`).join('') : '<img class="active" alt="" src="https://picsum.photos/600/400?random=5">'}
            <div class="dots">${dots}</div>
          </div>
          <div class="card-body">
            <div class="card-title">${escapeHtml(item.display_name||item.board_name||'Billboard')}</div>
            <div class="card-meta">${escapeHtml(item.address||'-')}</div>
            <div class="card-badges">
              <span class="badge ${item.active?'badge-active':'badge-inactive'}">${item.active?'Active':'Inactive'}</span>
              ${item.available?'<span class="badge badge-available">Available</span>':''}
              <span class="badge" style="background:#f3f4f6;color:#111827">${escapeHtml(item.billboard_type||'Type')}</span>
            </div>
            <div style="margin-top:8px">
              <strong class="price">${item.selling_standard_rate? '$'+fmt(item.selling_standard_rate):'-'}</strong>
              <span style="color:#6b7280"> std • </span>
              <strong class="price">${item.selling_monthly_rate? '$'+fmt(item.selling_monthly_rate):'-'}</strong>
              <span style="color:#6b7280">/mo</span>
            </div>
            <div class="card-actions">
              <button class="btn btn-sm btn-secondary" onclick="openBillboardBookings('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'Billboard')}')">Bookings</button>
              <button class="btn btn-sm btn-primary" onclick="toggleStatus('${escapeHtml(item.inventory_uuid)}', ${!!item.active}, '${escapeHtml(item.board_name||'')}')">${item.active?'Mark Inactive':'Mark Active'}</button>
              <button class="btn btn-sm btn-danger" onclick="deleteItem('${escapeHtml(item.inventory_uuid)}', '${escapeHtml(item.board_name||'')}')">Delete</button>
            </div>
          </div>`;
        grid.appendChild(card);
      });
      initCarousels();
    }

    function initCarousels(){
      document.querySelectorAll('.carousel').forEach(car=>{
        const imgs=[...car.querySelectorAll('img')]; if(imgs.length<2) return;
        const dots=[...car.querySelectorAll('.dot')]; let idx=0;
        setInterval(()=>{ imgs[idx].classList.remove('active'); dots[idx]?.classList.remove('active'); idx=(idx+1)%imgs.length; imgs[idx].classList.add('active'); dots[idx]?.classList.add('active'); }, 3000);
      });
    }

    function updatePagination(total){
      const totalPages=Math.max(1, Math.ceil(total/rowsPerPage));
      const from=(total===0)?0:(currentPage-1)*rowsPerPage+1;
      const to=Math.min(currentPage*rowsPerPage,total);
      $("#pageInfo").textContent=`Showing ${from}-${to} of ${fmt(total)} (Page ${currentPage} of ${totalPages})`;
      $("#prevBtn").disabled=currentPage===1; $("#nextBtn").disabled=currentPage>=totalPages;
      sessionStorage.setItem('page', String(currentPage));
      sessionStorage.setItem('rows', String(rowsPerPage));
    }

    function applyFilters(){ currentPage=1; loadInventory(); }
    function resetFilters(){ $("#searchInput").value=''; $("#countryFilter").value=''; $("#stateFilter").value=''; $("#typeFilter").value=''; $("#activeFilter").checked=true; $("#availableFilter").checked=true; currentPage=1; loadInventory(); }
    function firstPage(){ if(currentPage!==1){ currentPage=1; loadInventory(); } }
    function previousPage(){ if(currentPage>1){ currentPage--; loadInventory(); } }
    function nextPage(){ const totalPages=Math.max(1,Math.ceil(filteredCount/rowsPerPage)); if(currentPage<totalPages){ currentPage++; loadInventory(); } }
    function lastPage(){ const totalPages=Math.max(1,Math.ceil(filteredCount/rowsPerPage)); if(currentPage!==totalPages){ currentPage=totalPages; loadInventory(); } }

    $("#rowsSelect").addEventListener('change',e=>{ rowsPerPage=parseInt(e.target.value,10)||50; currentPage=1; loadInventory(); });

    /* ====== CRUD ====== */
    function openAddModal(){
      $("#modalTitle").textContent='Add New Site'; $("#submitBtn").textContent='Add Site';
      const form=$("#addModal form"); form.reset(); $("#activeStatus").value='true'; $("#availableStatus").value='true';
      show($("#addModal")); setTimeout(()=>$("#boardName").focus(),0);
    }
    function closeModal(){ hide($("#addModal")); }

    async function handleSubmit(e){
      e.preventDefault();
      const data={
        inventory_uuid:'INV-'+Date.now(),
        board_name:$("#boardName").value,
        display_name:$("#displayName").value,
        reference_id:$("#referenceId").value,
        country:$("#country").value,
        state:$("#state").value,
        district:$("#district").value,
        address:$("#address").value,
        billboard_type:$("#billboardType").value,
        selling_standard_rate:parseFloat($("#standardRate").value)||null,
        selling_monthly_rate:parseFloat($("#monthlyRate").value)||null,
        no_of_screens:parseInt($("#noOfScreens").value)||null,
        active:$("#activeStatus").value==='true',
        available:$("#availableStatus").value==='true'
      };
      const {error}=await supabase.from('inventory_production').insert([data]);
      if(error) return toast(error.message,'error');
      toast('Site added'); closeModal(); await loadStats(); await loadInventory();
    }

    async function toggleStatus(uuid, currentStatus, boardName){
      const newStatus=!currentStatus; const statusText=newStatus?'Active':'Inactive';
      if(!confirm(`Change "${boardName}" to ${statusText}?`)) return;
      const {data,error}=await supabase.from('inventory_production').update({active:newStatus}).eq('inventory_uuid',uuid).select();
      if(error) return toast(error.message,'error');
      if(data&&data.length){ toast(`Changed to ${statusText}`); await loadStats(); await loadInventory(); }
      else toast('No rows updated','error');
    }

    async function deleteItem(uuid,name){
      if(!confirm(`Delete ${name}?`)) return;
      const {error}=await supabase.from('inventory_production').delete().eq('inventory_uuid',uuid);
      if(error) return toast('Delete failed','error');
      toast('Deleted'); await loadStats(); await loadInventory();
    }

    /* ====== CSV & Export ====== */
    const dz=$("#dropzone");
    ['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();dz.classList.add('drag')}));
    ['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();dz.classList.remove('drag')}));
    dz.addEventListener('drop',e=>{const f=e.dataTransfer.files?.[0]; if(f) handleFileUpload({target:{files:[f]}})});

    function downloadCSVTemplate(){
      const template=`inventory_uuid,board_name,display_name,reference_id,country,state,district,address,latitude,longitude,gps_coordinates,media_owner,active,available,billboard_type,board_format,images,selling_standard_rate,selling_monthly_rate,no_of_screens,resolution,programmatic_enabled,exposure_to_dsp
INV-SAMPLE-001,Downtown Billboard,Main Street Digital,REF-001,USA,California,Los Angeles,123 Main St,34.0522,-118.2437,"34.0522,-118.2437",ABC Media,true,true,Digital,Landscape,https://example.com/img1.jpg|https://example.com/img2.jpg,5000,15000,1,1920x1080,Yes,Yes`;
      const blob=new Blob([template],{type:'text/csv'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='inventory_template.csv'; a.click(); URL.revokeObjectURL(a.href); toast('Template downloaded');
    }

    function exportCurrentView(){
      const headers=["Board Name","Location","Country","State","Type","Standard Rate","Monthly Rate","Screens","Active","Available"];
      let rows=[];
      if(viewMode==='list'){
        rows=[...document.querySelectorAll('#inventoryBody tr')].map(tr=>{
          const td=[...tr.querySelectorAll('td')];
          if(!td.length) return null;
          const st=td[8].innerText;
          return [td[0].innerText.trim(),td[1].innerText.trim(),td[2].innerText.trim(),td[3].innerText.trim(),td[4].innerText.trim(),
                  td[5].innerText.replace(/,/g,''),td[6].innerText.replace(/,/g,''),td[7].innerText.trim(),
                  String(/Active/.test(st)&&!/Inactive/.test(st)), String(/Available/.test(st))];
        }).filter(Boolean);
      }else{
        rows=lastData.map(i=>[i.board_name||'',i.address||'',i.country||'',i.state||'',i.billboard_type||'',
              i.selling_standard_rate||'',i.selling_monthly_rate||'',i.no_of_screens??'',String(!!i.active),String(!!i.available)]);
      }
      const csv=[headers,...rows].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`inventory_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href); toast('Exported');
    }

    function handleFileUpload(e){
      const file=e.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=async ev=>{
        const lines=String(ev.target.result||'').split('\n'); if(!lines.length) return toast('CSV empty','error');
        const items=[];
        for(let i=1;i<lines.length;i++){
          if(!lines[i].trim()) continue;
          const v=lines[i].split(',').map(s=>s.trim());
          items.push({
            inventory_uuid:v[0]||'INV-'+Date.now()+'-'+i, board_name:v[1]||'', display_name:v[2]||v[1]||'', reference_id:v[3]||'',
            country:v[4]||'', state:v[5]||'', district:v[6]||'', address:v[7]||'',
            latitude:v[8]?parseFloat(v[8]):null, longitude:v[9]?parseFloat(v[9]):null, gps_coordinates:v[10]||'',
            media_owner:v[11]||'', active:v[12]==='true'||v[12]==='1'||v[12]==='TRUE', available:v[13]==='true'||v[13]==='1'||v[13]==='TRUE',
            billboard_type:v[14]||'', board_format:v[15]||'', images:v[16]||'',
            selling_standard_rate:v[17]?parseFloat(v[17]):null, selling_monthly_rate:v[18]?parseFloat(v[18]):null,
            no_of_screens: v[19]?parseInt(v[19]):null, resolution:v[20]||'', programmatic_enabled:v[21]||'No', exposure_to_dsp:v[22]||'No'
          });
        }
        if(!items.length) return toast('No valid rows','error');
        if(!confirm(`Upload ${items.length} items?`)) return;
        let uploaded=0; const batch=100;
        for(let i=0;i<items.length;i+=batch){
          const {error}=await supabase.from('inventory_production').insert(items.slice(i,i+batch));
          if(error){toast(error.message,'error'); break;} uploaded+=Math.min(batch, items.length-i);
        }
        toast(`Uploaded ${uploaded}`); $("#csvFile").value=''; await loadStats(); await loadInventory();
      };
      reader.readAsText(file);
    }

    /* ====== Map ====== */
    async function initMap(){
      if(!currentUser) return;

      if(!map){
        map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
      }

      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const {data, error} = await supabase
        .from('inventory_production')
        .select('*')
        .eq('organization_id', currentUser.organizationId)
        .not('latitude', 'is', null)
        .not('longitude', 'is', null);

      if(error){ toast('Failed to load map data', 'error'); return; }
      if(!data || data.length === 0){ toast('No billboards with GPS coordinates', 'error'); return; }

      const bounds = [];
      data.forEach(item => {
        const lat = parseFloat(item.latitude);
        const lng = parseFloat(item.longitude);
        if(!lat || !lng || isNaN(lat) || isNaN(lng)) return;

        bounds.push([lat, lng]);
        let color = '#6b7280';
        if(item.active && item.available) color = '#10b981';
        else if(item.active) color = '#f59e0b';

        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background:${color};width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });

        const popupContent = `
          <div class="map-popup">
            <h3>${escapeHtml(item.board_name || 'Billboard')}</h3>
            <div class="detail"><span class="label">Location:</span><span>${escapeHtml(item.address || '-')}</span></div>
            <div class="detail"><span class="label">Type:</span><span>${escapeHtml(item.billboard_type || '-')}</span></div>
            <div class="detail"><span class="label">Standard Rate:</span><span class="price">${item.selling_standard_rate ? '$'+fmt(item.selling_standard_rate) : '-'}</span></div>
            <div class="detail"><span class="label">Monthly Rate:</span><span class="price">${item.selling_monthly_rate ? '$'+fmt(item.selling_monthly_rate) : '-'}</span></div>
            <div class="detail"><span class="label">Status:</span><span><span class="badge ${item.active?'badge-active':'badge-inactive'}">${item.active?'Active':'Inactive'}</span>${item.available?'<span class="badge badge-available">Available</span>':''}</span></div>
          </div>`;

        const marker = L.marker([lat, lng], {icon}).addTo(map);
        marker.bindPopup(popupContent);
        markers.push(marker);
      });

      if(bounds.length > 0){ map.fitBounds(bounds, {padding: [50, 50]}); }
      toast(`Showing ${data.length} billboards on map`);
    }

    /* ====== Bookings ====== */
    let currentBillboardForBooking = null;

    function openBillboardBookings(inventoryUuid, boardName){
      currentBillboardForBooking = inventoryUuid;
      $("#billboardBookingsTitle").textContent = `Bookings: ${boardName}`;
      show($("#billboardBookingsModal"));
      hide($("#newBookingForm"));
      loadBillboardBookings();
    }

    function closeBillboardBookings(){
      hide($("#billboardBookingsModal"));
      currentBillboardForBooking = null;
    }

    function openNewBookingForm(){
      show($("#newBookingForm"));
      const today = new Date().toISOString().split('T')[0];
      $("#bookingStartDate").value = today;
      const nextWeek = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
      $("#bookingEndDate").value = nextWeek;
    }

    function cancelNewBooking(){
      hide($("#newBookingForm"));
      $("#newBookingForm form").reset();
    }

    async function loadBillboardBookings(){
      if(!currentBillboardForBooking) return;
      
      const {data, error} = await supabase
        .from('bookings')
        .select('*')
        .eq('inventory_uuid', currentBillboardForBooking)
        .order('start_date', {ascending: false});
      
      if(error){ toast('Failed to load bookings', 'error'); return; }
      
      const list = $("#billboardBookingsList");
      if(!data || data.length === 0){
        list.innerHTML = '<p style="color:#6b7280;padding:20px;text-align:center;background:#f9fafb;border-radius:8px">No bookings yet. Click "New Booking" to create one.</p>';
        return;
      }
      
      list.innerHTML = data.map(b => `
        <div class="booking-card">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
            <h4 style="margin:0">${escapeHtml(b.campaign_name || 'Booking')}</h4>
            <span class="booking-status ${b.status}">${b.status}</span>
          </div>
          <div class="meta">📅 <strong>${b.start_date}</strong> to <strong>${b.end_date}</strong></div>
          <div class="meta">👤 Client: ${escapeHtml(b.client_name || 'Not specified')}</div>
          ${b.notes ? `<div class="meta" style="margin-top:6px;padding:8px;background:#f9fafb;border-radius:6px">📝 ${escapeHtml(b.notes)}</div>` : ''}
          <div style="margin-top:10px;display:flex;gap:6px">
            <button class="btn btn-sm btn-danger" onclick="deleteBooking('${b.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    async function handleBookingSubmit(e){
      e.preventDefault();
      
      const booking = {
        inventory_uuid: currentBillboardForBooking,
        organization_id: currentUser.organizationId,
        start_date: $("#bookingStartDate").value,
        end_date: $("#bookingEndDate").value,
        client_name: $("#bookingClient").value,
        campaign_name: $("#bookingCampaign").value,
        status: $("#bookingStatus").value,
        notes: $("#bookingNotes").value,
        created_by: currentUser.id
      };
      
      const {error} = await supabase.from('bookings').insert([booking]);
      if(error){ toast(error.message, 'error'); return; }
      
      toast('Booking created successfully');
      cancelNewBooking();
      loadBillboardBookings();
    }

    async function deleteBooking(id){
      if(!confirm('Delete this booking? This cannot be undone.')) return;
      const {error} = await supabase.from('bookings').delete().eq('id', id);
      if(error){ toast('Delete failed', 'error'); return; }
      toast('Booking deleted');
      loadBillboardBookings();
    }

    /* ====== Misc ====== */
    function syncNow(){ loadStats(); loadInventory(); toast('Synced'); }

    window.addEventListener('load', ()=>{
      const savedRows=parseInt(sessionStorage.getItem('rows')||'50',10); rowsPerPage=isNaN(savedRows)?50:savedRows; $("#rowsSelect").value=String(rowsPerPage);
      const savedView=sessionStorage.getItem('view'); if(savedView) viewMode=savedView;
      const savedPage=parseInt(sessionStorage.getItem('page')||'1',10); if(!isNaN(savedPage)) currentPage=savedPage;
    });

    // expose to window
    window.applyFilters=applyFilters; window.resetFilters=resetFilters; window.exportCurrentView=exportCurrentView;
    window.openAddModal=openAddModal; window.closeModal=closeModal;
    window.toggleStatus=toggleStatus; window.deleteItem=deleteItem;
    window.firstPage=firstPage; window.previousPage=previousPage; window.nextPage=nextPage; window.lastPage=lastPage;
    window.downloadCSVTemplate=downloadCSVTemplate; window.syncNow=syncNow;
    window.setView=setView; window.setTab=setTab; window.handleLogin=handleLogin; window.handleLogout=handleLogout;

    // bookings
    window.openBillboardBookings=openBillboardBookings;
    window.closeBillboardBookings=closeBillboardBookings;
    window.openNewBookingForm=openNewBookingForm;
    window.cancelNewBooking=cancelNewBooking;
    window.handleBookingSubmit=handleBookingSubmit;
    window.deleteBooking=deleteBooking;
  </script>
</body>
</html>
